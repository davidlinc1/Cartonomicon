<html>
  <!-- See also: http://kempe.net/blog/2014/06/14/leaflet-pan-zoom-image.html -->
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css">
    <link rel="stylesheet" type="text/css" href="css/semantic.css">
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <link rel="stylesheet" href="css/leaflet-list-markers.css" />

    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /> -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">


    <style>
    #image-map {
      width: 100vw;
      height: 100vh;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    /* The side navigation menu */

/*.leaflet-control-zoom.leaflet-bar.leaflet-control {
    margin-top: 80px;
    margin-left: 12px;
}*/

@font-face {
    font-family: "Breathe Fire";
    src: url("fonts/Breathe-Fire.ttf") format("truetype");
}

body{ 
margin: 0; 
font-family: "Open Sans";
overflow: hidden;
}

a {
    color: #1d569f;
    cursor: pointer;
}

i.fa {
    padding-top: 12px;
}

.changeMapLink {
    font-size: 12px;
    padding-left: 4px;
}


.leaflet-control-attribution {
    display: none;
}

.list-markers-li a {
    color: #000;
}

div#sidebar {
    border: 0;
    border-radius: 0;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 9998;
}

.sidebar-content {
    background-color: #f3f3f3;
}

.sidebar-tabs {
    box-shadow: 2px 0px 1px #00000014;
    z-index: 9999;
}

.sidebar-pane.not(#place) > .sidebar-header {
    margin: -10px -20px 0;
}

/*#sidebar {
        height: 50vh;
    min-height: 250px;
}*/

/*.list-markers.leaflet-control {
    display: none;
}

.list-markers.leaflet-control.active {
    display: block;
}*/

.leaflet-popup-content {
    text-align: center;
    font-size: 24px;
    width: auto !important;
    font-family: "Breathe Fire";
}


#image-map .leaflet-top.leaflet-left {
    left: 44px;
}

.ui.image.icon-mapPin > img {
    max-width: 140px;
    padding: 0px 25px 0px 25px;
    margin: 0 auto;
}

i.fa.checkmark {
    left: auto;
    bottom: 0;
    right: 0em;
    border-radius: 0px;
    border-top-right-radius: inherit;
    border-bottom-right-radius: inherit;
    -webkit-box-shadow: 1px 0px 0px 0px transparent inset;
    box-shadow: 1px 0px 0px 0px transparent inset;
    position: absolute;
    height: 100%;
    line-height: 1;
    border-radius: 0px;
    border-top-left-radius: inherit;
    border-bottom-left-radius: inherit;
    text-align: center;
    margin: 0em;
    width: 2.57142857em;
    background-color: rgba(0, 0, 0, 0.05);
    color: '';
    -webkit-box-shadow: -1px 0px 0px 0px transparent inset;
    box-shadow: -1px 0px 0px 0px transparent inset;
}

.markerType {
    cursor: pointer;
}

.ui.medium.image.icon-mapPin {width: 140px;}

.markerColumns {
    width: 100%;
}

.markerColumns i {
    padding-right: 8px;
}

.markerType {
    margin-top: 18px;
    margin-bottom: 18px;
}

.storedElementListContainer img.ui.avatar.image,
.elementListContainer img.ui.avatar.image {
    width: auto;
    height: auto;
    margin-right: 12px;
}

.markerForm {
    display: none;
}

i.fa.noIconPadding {
    padding-top: 0px;
}


.padded.markerForm {
    margin-top: 20px;
}

.elementImage {
    height: 300px;
    width: 100%;
    background-size: 100%;
    background-repeat: no-repeat;
}

.elementImage {
  display: none;
}

div#place {
padding: 0px;
}

.sidebar-pane {
    padding-top: 0px;
}

div#place > h1.sidebar-header > span, div#place .markerTitle, div#place .markerDescription {padding: 10px 20px;}

.ui.placeMenuDivider.divider {
    margin-top: 65px;
}

.markerMenu {
  z-index: 9999 !important;
}

.ui.right.floated.menu.markerContextMenu {
    margin-right: 10px;
    margin-bottom: 2px;
}

.ui.right.floated.menu.markerContextMenu.editMarkerToolbar {
	margin-top: 10px;
}

.articleTitleHeader {
    margin: 0px;
}

.markerTitle[contenteditable="true"],
.markerDescription[contenteditable="true"] {
    border: 1px solid #d7d7d7;
}

.leaflet-popup-close-button {
    display: none;
}

.inputfile {
  padding: 25px;
    display: block;
    border: 3px dashed #0000000d;
    cursor: pointer;
}

label.fileUploadLabel {
    font-size: 10px;
    color: #dddddd;
}

form.fileUploadForm {
    margin: 50px;
    margin-top: 10px;
    margin-bottom: 20px;
}
.uploadNewMapForm {
  margin-top: 25px;
}

.uploadFileButton {
  cursor: pointer;
}

.uploadFileButton:hover {
  background: #f4f4f4;
}

.uploadFileButton.disabled {
    pointer-events: none;
}

.hidden {
  display: none !important;
}

.markerTypeFilter {
  display: none;
}

.mapLinkPreviewContainer {
    margin: 0 auto;
    margin-bottom: 50px;
    display: block;
    width: 60%;
}

.mapLinkPreview {
display: block;
width: 60%;
}

.mapLinkLabel {
  font-weight: bold;
  font-size: 14px;
}

a.ui.button.upOneLevelButton {
    margin-top: 20px;
}

.leaflet-popup.leaflet-zoom-animated {
    min-width: 200px;
}

.actions.elementLinkButtons > .deny.button {
    margin-left: 0px;
}

.actions.elementLinkButtons {
    margin-top: 19px;
}

#cke_markerDescription {
    display: none;
}

iframe#markerDescription_ifr {
    height: 53vh !important;
}

.allMarkers {
    padding: 20px;
}

img.ui.avatar.map.image {
    max-width: 34px;
    border-radius: 0;
    margin-right: 15px;
}

#tinymce > p,
.markerDescription > p {
    margin-bottom: 16px !important;
}


.showThisMarker, .showAllMarkers {
    width: 50%;
}

p.markerDescription img {
    max-width: 100%;
}

.cke_inner.cke_reset.cke_maximized {
    z-index: 9999 !important;
}

.markerLayerLabel {
    position: relative;
    display: inline-block;
    top: 10px;
}

div#markerLayers .item {
    padding: 10px;
    padding-right: 0px;
}

div#markerLayers .item:hover {
    background: rgba(255, 255, 255, 0.35);
    cursor:pointer;
}

.ui.newCategory {
    border: 2px dashed #d0d0d0;
    padding: 7px;
    margin: 14px;
}

div#storedElements {
    padding: 0;
}

#storedElements > .ui.header, #storedElements p {
    padding-left: 20px;
    padding-right: 20px;
}

div#storedElements .appTitle {
    padding-left: 20px;
}

.ui.list.markerListContainer {
    padding-left: 20px;
    padding-bottom: 12px;
}

.categoryContainer i {
    color: #7c7c7c;
}

.categoryContainer p {
    font-weight: bold;
}

.ui.list.markerListContainer .header {
    font-weight: 300;
}

.wikiContainer {
    padding: 20px;
}

.wikiContainer .item > .header {
    font-weight: 400;
}

.categoryDropdown, .subcategoryDropdown {
  cursor: pointer;
}

p.subcategoryDropdown {
    padding-top: 10px;
}

.wikiContainer p {
    margin: auto;
    padding: unset;
}

#storedElements > .ui.header, #storedElements p, .wikiContainer .item > .header {
    padding-left: 20px;
    padding-right: 20px;
}

.subcategoryDropdown.open {
    margin-bottom: 8px;
}

p.categoryContainer {
    margin-bottom: 4px;
}

.wikiContainer .addNew i.fa.fa-trash {
    color: #b01825;
    padding-right: 4px;
}

.wikiContainer .addNew > .header, .wikiContainer .addNew i {
    color: #0074d9;
}
.wikiContainer .addNew > .header {
    text-transform: uppercase;
    font-weight: bold;
    font-size: 11px;
    margin-top: 5px;
    margin-bottom: 14px;
    
}

.categoryDropdown.open > .item, .subcategoryDropdown.open > .item, .categoryContainer > .item {
    padding-left: 28px;
}

.subcategoryItem {
    cursor: pointer;
}

.subcategoryItem:hover {
    background: #e8e8e8;
}
.subcategoryItem.active {
    background: gainsboro;
}

.articleContent {
    margin: 25px;
    margin-top: 45px;
    padding: 18px;
}

.modals.dimmer .ui.modal.wikiArticleModal {
    width: calc(100% - 460px);
    margin-left: 230px;
    overflow-y: scroll;
    height: 100vh;
    margin-top: 0px;
    margin-bottom: 0px;
    padding-top: 0px !important;
}

.ui.dimmer.modals.page.transition.visible.active {
    padding-top: 0px;
}

.ui.newCategory:hover {
    background: gainsboro;
    cursor: pointer;
}

#cke_articleContent:not(.visibleModal) {
  display: none !important;
}

.markerLayersList > .item.active {
    background: #e8f1f8 !important;
}




/* Add new css above this line */



@media (max-width: 700px) {
  .modals.dimmer .ui.scrolling.modal.addMarker {
    margin-left: 20px;
    width: 85%;
}
}


/* On smaller screens, where height is less than 450px, change the style of the sidenav (less padding and a smaller font size) */
@media screen and (max-height: 450px) {
    .sidenav {padding-top: 15px;}
    .sidenav a {font-size: 18px;}
}
    </style>
  </head>
  <body>

<div class="ui mini modal createNewMarkerLayerModal scrolling">
  <i class="fa fa-close close"></i>
  <div class="header">
      Create new marker layer
    </div>
  <div class="newWikiElementContent content">
    <p>Name your marker layer. Then, edit markers to add them to this layer.</p>
    <div class="ui fluid input">
  <input type="text" placeholder="New layer name...">
</div>
  </div>
  <div class="actions">
      <div class="ui negative button">
        Cancel
      </div>
      <div class="ui positive right labeled icon button addNewMarkerLayerButton">
        Add
        <i class="checkmark icon"></i>
      </div>
    </div>
</div>

<div class="ui mini modal createNewWikiArticle scrolling">
  <i class="fa fa-close close"></i>
  <div class="header">
      Create new encyclopedia article
    </div>
  <div class="newWikiElementContent content">
    <p>Enter a new article name. You can then edit the content.</p>
    <div class="ui fluid input">
  <input type="text" placeholder="Add article name">
</div>
  </div>
  <div class="actions">
      <div class="ui negative button">
        Cancel
      </div>
      <div class="ui positive right labeled icon button addNewArticleButton">
        Add
        <i class="checkmark icon"></i>
      </div>
    </div>
</div>

<div class="ui mini modal createNewWikiCategory scrolling">
  <i class="fa fa-close close"></i>
  <div class="header">
      Create new encyclopedia category
    </div>
  <div class="newWikiElementContent content">
    <p>Enter a new category name. You can then add new articles to it.</p>
    <div class="ui fluid input">
  <input type="text" placeholder="Add category name">
</div>
  </div>
  <div class="actions">
      <div class="ui negative button">
        Cancel
      </div>
      <div class="ui positive right labeled icon button addNewCategoryButton">
        Add
        <i class="checkmark icon"></i>
      </div>
    </div>
</div>


<div class="ui mini modal addMarkerToWiki transition">
  <i class="fa fa-close close"></i>
  <div class="header">Add marker to encyclopedia category</div>
  <div class="newWikiElementContent content">
    <p>Choose an encyclopedia category to move this marker into, removing it from the map.</p>
    <div class="ui tiny dropdown labeled search icon button markerWikiCategoryDropdownButton" style="border-radius: 0;position: relative;top: 6px;">
<i class="fa fa-tags" style="
    position: absolute;
    height: 100%;
    line-height: 1;
    border-radius: 0px;
    border-top-left-radius: inherit;
    border-bottom-left-radius: inherit;
    text-align: center;
    margin: 0em;
    width: 2.57142857em;
    background-color: rgba(0, 0, 0, 0.05);
    color: '';
    -webkit-box-shadow: -1px 0px 0px 0px transparent inset;
    box-shadow: -1px 0px 0px 0px transparent inset;
    top: 0em;
    left: 0em;
"></i>
  <input class="search" autocomplete="off" tabindex="0"><span class="text currentWikiCategoryText currentText">Select wiki category</span>
  <div class="menu wikiCategorySelectMenu"></div>
</div>
  </div>
  <!-- <div class="actions">
      <div class="ui negative button">
        Cancel
      </div>
      <div class="ui positive right labeled icon button addNewCategoryButton">
        Save
        <i class="checkmark icon"></i>
      </div>
    </div> -->
</div>

<div class="ui modal wikiArticleModal scrolling">
  <i class="fa fa-close close"></i>
  <div class="header articleTitle">
    <h2 class="articleTitleHeader"></h2>
     <div class="ui tiny dropdown hidden labeled search icon button wikiCategoryDropdownButton" style="border-radius: 0;position: relative;top: 6px;">
<i class="fa fa-tags" style="
    position: absolute;
    height: 100%;
    line-height: 1;
    border-radius: 0px;
    border-top-left-radius: inherit;
    border-bottom-left-radius: inherit;
    text-align: center;
    margin: 0em;
    width: 2.57142857em;
    background-color: rgba(0, 0, 0, 0.05);
    color: '';
    -webkit-box-shadow: -1px 0px 0px 0px transparent inset;
    box-shadow: -1px 0px 0px 0px transparent inset;
    top: 0em;
    left: 0em;
"></i>
  <span class="text currentWikiCategoryText">Select wiki category</span>
  <div class="menu wikiCategorySelectMenu">
  </div>
</div>

      <div class="ui right floated main menu markerContextMenu" style="
    float: right;
    margin: 0;
">
        <a class="icon item" id="closeWikiModal" title="Close window">
          <i class="close icon"></i>
        </a>
        
        
      </div>

<div class="ui right floated main menu markerContextMenu articleEditContainer" style="
    margin: 0;
    margin-right: 20px;
">
        <a class="icon item" id="editWikiArticle" title="Edit article">
          <i class="edit icon"></i>
        </a>
        <a class="icon item active green" id="saveWikiArticle" title="Edit article" style="
    background: #12812c;
    color: white !important;
    font-weight: bold;
    display: none;
">
          Save
        </a>
        <div class="ui language dropdown right floating icon item" id="deleteWikiArticle" title="Delete article" tabindex="0">
          <i class="red trash icon"></i>
        <div class="menu" tabindex="-1"></div></div>

      </div>

      <div class="ui right floated main menu markerContextMenu wikiSaveButtonContainer hidden">
        <a class="icon item active green" id="saveArticleEdit" title="Save changes to article" style="background: rgb(18, 129, 44); font-weight: bold; color: white !important;">
          Save
        </a><a class="icon item active red" id="cancelArticleEdit" title="Cancel without saving" style="background: rgb(186, 71, 71); font-weight: bold; color: white !important;">Cancel</a>
      </div>
  </div>
  <div contenteditable="true" id="articleContent" class="articleContent"></div>
</div>

<div class="ui modal addMarker">
  <i class="fa fa-close close"></i>
  <div class="header">
    Add marker
  </div>
  <div class="image content">
    <div class="ui medium image icon-mapPin">
      <img src="img/map-pin-icon.png">
    </div>
    <div class="markerColumns">
      <h2 class="ui header">Use an existing element, or create a new one.</h2>
      <div class="ui vertical stripe segment">
    <div class="ui equal width stackable internally celled grid">
        <div class="column">
          <h3> <i class="fa fa-link"></i> Link existing</h3>
          <p>Select from existing elements</p>
          <div class="ui category search markerSearch linkElementSearch">
  <div class="ui fluid icon input">
    <input class="prompt" type="text" placeholder="Search people, places things...">
    <i class="search icon"></i>
  </div>
  <div class="results"></div>
</div>
        </div>
        <div class="column">
          <h3><i class="fa fa-plus"></i> Create new</h3>
          <p>Add a new element to your map</p>
          <div class="ui floating labeled icon dropdown button createNewElementDropdown">
  <i class="fa fa-layer-group" style="
    position: absolute;
    height: 100%;
    line-height: 1;
    border-radius: 0px;
    border-top-left-radius: inherit;
    border-bottom-left-radius: inherit;
    text-align: center;
    margin: 0em;
    width: 2.57142857em;
    background-color: rgba(0, 0, 0, 0.05);
    color: '';
    -webkit-box-shadow: -1px 0px 0px 0px transparent inset;
    box-shadow: -1px 0px 0px 0px transparent inset;
    top: 0em;
    left: 0em;
    padding-left: 9px;
"></i>
  <span class="text">No marker layer selected</span>
  <div class="menu elementDropdownContainer">
    <div class="header">
      Marker layers
    </div>
    <div class="elementTypeContainer"></div>
    <div class="header containerFooter">
      Create new marker layer
    </div>
    <div class="item">
      <i class="fa fa-plus noIconPadding"></i>
      No marker layer selected
    </div>
  </div>
</div>
<div class="padded markerForm">

<div class="ui form">
  <div class="field">
    <label>Marker title</label>
    <input class="ui input markerTitleInput">
  </div>
<div class="field">
    <label>Marker description</label>
    <textarea class="markerDescriptionInput" rows="2"></textarea>
  </div>
</div>
</div>
<div class="actions elementLinkButtons">
    <div class="ui black deny button">
      Cancel
    </div>
    <div class="ui positive right labeled icon button addMarkerButton">
      Add marker
      <i class="fa fa-map-marker checkmark"></i>
    </div>
  </div>
        </div>
    </div>
  </div>
    </div>
  </div>
</div>



<div class="ui modal mini createNewWorldmapModal">
  <i class="fa fa-close close"></i>
  <div class="header">
    Create new worldmap
  </div>
  
<div class="content">
<div class="ui form">
  
  <div class="field">
        <label>Map name</label>
        <input type="text" name="map-name" class="newWorldmapNameInput" placeholder="Map name">
      </div>
  <div class="field">
    <label>Map description</label>
    <textarea class="newWorldmapDescriptionInput" placeholder="Map description"></textarea>
  </div>
</div>

<form action="uploadMapImage.php" class="uploadNewWorldmapForm" method="post" enctype="multipart/form-data">
    <label for="newWorldmapToUpload" class="fileUploadLabel"><span>Drag & drop or click to browse...</span></label>
    <input type="file" name="fileToUpload" id="newWorldmapToUpload" class="inputfile" data-multiple-caption="{count} files selected">
    <input type="submit" value="Upload Image" name="submit" class="ui segment uploadNewWorldmapButton hidden">
</form>

</div>


  <div class="actions">
    <div class="ui black deny button">
      Cancel
    </div>
    <div class="ui positive right labeled icon button addWorldmapButton">
      Add new map
      <i class="fa fa-map checkmark"></i>
    </div>
  </div>
</div>

<div class="ui modal mini editMapDetailsModal">
  <i class="fa fa-close close"></i>
  <div class="header">
    Edit map details
  </div>
  
<div class="content">
<div class="ui form">
  
  <div class="field">
        <label>Map name</label>
        <input type="text" name="map-name" class="editMapNameInput" placeholder="Map name">
      </div>
  <div class="field">
    <label>Map description</label>
    <textarea class="editMapDescriptionInput" placeholder="Map description"></textarea>
  </div>
</div>
</div>


  <div class="actions">
    <div class="ui black deny button">
      Cancel
    </div>
    <div class="ui positive button editMapButton">
      Edit map
    </div>
  </div>
</div>



<div class="ui modal addMapToMarkerModal">
  <i class="fa fa-close close"></i>
  <div class="header">
    Link a map to this marker
  </div>
  <div class="image content">
    <div class="ui medium image icon-mapPin">
      <img src="img/map-pin-icon.png">
    </div>
    <div class="markerColumns">
      <h2 class="ui header">Use an existing map, or upload a new one.</h2>
      <div class="ui vertical stripe segment">
    <div class="ui equal width stackable internally celled grid">
        <div class="column">
          <h3> <i class="fa fa-link"></i> Link existing map</h3>
          <div class="ui category search mapSearch">
  <div class="ui fluid icon input">
    <input class="prompt" type="text" placeholder="Search maps...">
    <i class="search icon"></i>
  </div>
  <div class="results"></div>
</div>
        </div>
        <div class="column createNewMapColumn">
          <h3><i class="fa fa-plus"></i> Create a new map</h3>

          <div class="ui form">
  
  <div class="field">
        <label>Map name</label>
        <input type="text" name="map-name" class="createNewMapNameInput" placeholder="Map name">
      </div>
  <div class="field">
    <label>Map description</label>
    <textarea class="createNewMapDescriptionInput" placeholder="Map description"></textarea>
  </div>
</div>
          <form action="uploadMapImage.php" class="uploadNewMapForm" method="post" enctype="multipart/form-data">
    <label for="newMapToUpload" class="fileUploadLabel"><span>Drag & drop or click to browse...</span></label>
    <input type="file" name="fileToUpload" id="newMapToUpload" class="inputfile" data-multiple-caption="{count} files selected">
    <input type="submit" value="Upload Image" name="submit" class="ui segment uploadNewMapButton hidden">
</form>
<div class="padded markerForm">

<div class="ui form">
  <div class="field">
    <label>Marker title</label>
    <input class="ui input markerTitleInput">
  </div>
<div class="field">
    <label>Marker description</label>
    <textarea class="markerDescriptionInput" rows="2"></textarea>
  </div>
</div>
</div>
        </div>
    </div>
  </div>
    </div>


  </div>
  <div class="mapLinkPreviewContainer hidden">
    <div class="ui form">
  <div class="grouped fields">
    <label for="fruit">Link to existing map, or create a new map with this map image?</label>
    <div class="field">
      <div class="ui radio checkbox linkExistingMapToggle">
        <input type="radio" name="fruit" checked="" tabindex="0" class="hidden">
        <label>Link to existing map</label>
      </div>
    </div>
    <div class="field">
      <div class="ui radio checkbox createNewMapToggle">
        <input type="radio" name="fruit" tabindex="0" class="hidden">
        <label>Create new map with this image</label>
      </div>
    </div>
  </div>

  <div class="ui hidden form createNewNestedMapForm">
  <div class="field">
        <label>Map name</label>
        <input type="text" name="first-name" placeholder="Map name" class="createNewMapTitle">
      </div>
  <div class="field">
    <label>Map description</label>
    <textarea placeholder="Map description" class="createNewMapDescription"></textarea>
  </div>
</div>

    <img class="mapLinkPreview">
  </div>
</div>

  <div class="actions">
    <div class="ui black deny button">
      Cancel
    </div>
    <div class="ui positive right labeled icon button addMapButton">
      Add new map
      <i class="fa fa-map checkmark"></i>
    </div>
  </div>
</div>

<div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li class="home tab"><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                <li class="map tab"><a href="#map" role="tab"><i class="fa fa-map"></i></a></li>
                <li class="place tab"><a href="#place" role="tab"><i class="fa fa-map-pin"></i></a></li>
                <li class="markerLayers tab"><a href="#markerLayers" role="tab"><i class="fa fa-layer-group"></i></a></li>
                <li class="storedElements tab"><a href="#storedElements" role="tab"><i class="fa fa-book"></i></a></li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa fa-cog"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    <span class="appTitle"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <h2 class="ui header">Start adding markers!</h2>

                <p>Click anywhere on the map to open the marker manager and add a new place/person/thing.</p>
                <div class="ui divider"></div>
                
                <h2 class="markerTypeFilter">
                <div class="ui dropdown">
  <div class="text">Everything</div>
  <i class="dropdown icon"></i>
  <div class="menu">
    <div class="item active">Everything</div>
    <div class="item">People</div>
    <div class="item">Places</div>
    <div class="item">Artifacts</div>

  </div>
</div>
</h2>
            </div>

            <div class="sidebar-pane" id="map">
                <h1 class="sidebar-header">
                    <span>Current worldmap</span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <a class="ui button upOneLevelButton hidden"><i class="fa fa-level-up noIconPadding"></i>  Back to parent map</a>

                <h2 class="mapTitle"><div class="ui dropdown">
  <div class="mapTitleHeader text"></div>
  <i class="dropdown icon"></i>
  <div class="menu">
    <div class="item">
      <i class="dropdown icon"></i>
      Change worldmap
      <div class="menu mapContainer">
      </div>
    </div>
    <div class="divider"></div>
    <div class="item createNewWorldmap">New map</div>
    <div class="item editMapDetails">Edit map details</div>
    <div class="item disabled">Copy map</div>
    <div class="divider"></div>
    <div class="item deleteWorldmap"><i class="trash icon"></i> Delete this worldmap</div>
  </div>
</div></h2>
                <p class="mapDescription"></p>
                <div class="ui divider"></div>

                <h3>Maps linked to this map</h3>
                <div class="linkedMapsContainer"></div>
                

                <div class="mapLayerContainer" style="display: none;">
                <h3 class="currentMapLayer">
                    <div class="ui horizontal divider">
        Current layer
      </div>
                    <div class="ui dropdown">
  <div class="text">Kingdoms</div>
  <i class="dropdown icon"></i>
  <div class="menu">
    <div class="item">
      <i class="dropdown icon"></i>
      Change marker layer
      <div class="menu">
        <div class="item active">Kingdoms</div>
        <div class="item">People</div>
        <div class="item">Combat sites</div>
        <div class="item">Journey of the Myriad</div>
        <div class="item">Sacred Shrines</div>
        <div class="item">Artifacts</div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="item">New layer</div>
    <div class="item">Edit layer description</div>
    <div class="item">Copy layer</div>
    <div class="item"><i class="trash icon"></i> Delete layer</div>
  </div>
</div>
                </h3>

                <p>Showing the capital cities of each kingdom in the known civilized Kharlian world.</p>
                <p>The <b class="currentMarkerLayerTitle">Kingdoms</b> layer of <b class="currentMapLayerTitle">The Kharlian Continents</b> contains the following kinds of markers:</p>
                <div class="markerTypeContainer">
                  
                </div>
    
    <div class="markerType createNewMarkerType">
      <i class="fa fa-plus noIconPadding"></i>
      New element type...
    </div>
 
            </div>
</div>
            <div class="sidebar-pane" id="place">
                <h1 class="sidebar-header">
                    <span>Current marker</span>
                    <span class="sidebar-close"><i class="fa fa-caret-left noIconPadding"></i></span>
                </h1>

                <div class="ui large basic buttons" style="
    display: block;
    margin: 0 auto;
    text-align: center;
">
  <button class="ui button active showThisMarker">This marker</button>
  <button class="ui button showAllMarkers">All markers</button>
</div>
                <div class="allMarkers hidden">
                  
                  <div class="ui category search markerSearch">
                  <div class="ui fluid icon input">
                    <input class="prompt" type="text" placeholder="Filter people, places things...">
                    <i class="filter icon"></i>
                  </div>
                  <div class="results"></div>
                </div>
                <div class="elementListContainer"></div>

                </div>
                <div class="currentMarker">
                <form action="uploadElementImage.php" class="fileUploadForm hidden" method="post" enctype="multipart/form-data">
    <label for="fileToUpload" class="fileUploadLabel"><span>Drag & drop or click to browse...</span></label>
    <input type="file" name="fileToUpload" id="fileToUpload" class="inputfile" data-multiple-caption="{count} files selected">
    <input type="submit" value="Upload Image" name="submit" class="ui segment uploadFileButton hidden">
</form>

                <div class="elementImage"></div>

        <div class="ui right floated main menu markerContextMenu editMarkerToolbar">
        <a class="icon item disabled" id="editMarker" title="Edit marker">
          <i class="edit icon"></i>
        </a>
        <a class="icon item active green" id="saveMarkerEdit" title="Save marker changes" style="
    background: #12812c;
    color: white !important;
    font-weight: bold;
    display: none;
">
          Save
        </a><a class="icon item active red" id="cancelMarkerEdit" title="Cancel without saving" style="
    background: #ba4747;
    color: white !important;
    font-weight: bold;
    display: none;
">Cancel</a>
        <div class="ui language dropdown right floating icon item disabled" id="deleteMarker" title="Put marker in storage">
          <i class="folder icon"></i>
        </div>
      </div>

      <div class="ui right floated main menu markerContextMenu editMarkerToolbar">
        
        <div class="ui language dropdown right floating icon item disabled" id="addMapToMarker" title="Link a map">
          <span class="mapLinkLabel">Map</span>
        <div class="menu" tabindex="-1"></div>
        
      </div>
      <div class="ui language dropdown right floating icon item hidden" id="unlinkMapButton" title="Unlink nested map">
          <span class="mapUnlinkLabel">Unlink map</span>
        <div class="menu" tabindex="-1"></div></div>
      </div>
                <!-- <div class="ui placeMenuDivider divider"></div> -->
                <br><br>
                <h2 contenteditable="false" class="markerTitle">No marker selected</h2>
                <div class="ui fluid dropdown labeled search icon button hidden markerLayerDropdownButton" style="border-radius: 0;">
<i class="fa fa-layer-group" style="
    position: absolute;
    height: 100%;
    line-height: 1;
    border-radius: 0px;
    border-top-left-radius: inherit;
    border-bottom-left-radius: inherit;
    text-align: center;
    margin: 0em;
    width: 2.57142857em;
    background-color: rgba(0, 0, 0, 0.05);
    color: '';
    -webkit-box-shadow: -1px 0px 0px 0px transparent inset;
    box-shadow: -1px 0px 0px 0px transparent inset;
    top: 0em;
    left: 0em;
"></i>
  <span class="text currentlySelectedItemText">Select marker layer</span>
  <div class="menu markerLayerSelectMenu">

  </div>
</div>
                <!-- <div class="ui fluid right icon input addNewImageLink" style="display: none">
                <input type="text" placeholder="Add an image link">
                <i class="image icon"></i> 
              </div> -->
                <textarea id="markerDescription" contenteditable="false"></a></textarea>
                <p class="markerDescription"></p>
            </div>
            </div>


            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Settings<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <h1 class="lorem">Hmm what should go on the settings screen</h1>
            </div>
        
        <div class="sidebar-pane" id="storedElements">
                <h1 class="sidebar-header">
                    <span class="appTitle"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <h2 class="ui header">Map encyclopedia</h2>

                <p>Here you can organize articles and add them to the map as markers later.</p>
                <p>Click one to delete it, or place it back on the map by clicking "New element" when adding a marker on the map.</p>
                <div class="ui divider"></div>
                <div class="categoryContainer">
                <div class="ui newCategory">
    <p><i class="ui plus square outline icon"></i> New category</p>
  </div>

  <div class="ui category search markerSearch focus" style="
    padding-left: 10px;
    padding-right: 10px;
">
                  <div class="ui fluid icon input">
                    <input class="prompt" type="text" placeholder="Filter people, places things..." autocomplete="off">
                    <i class="filter icon"></i>
                  </div>
                  <div class="results"></div>
  </div>

<div class="wikiContainer">


<!--   <p>Category <i class="ui icon angle down"></i></p>
  <div class="ui tiny secondary inverted button">Edit</div> 

  <div class="ui list markerListContainer">
  <div class="item">
    <div class="header">New York City</div>
  </div>
  <div class="item">
    <div class="header">Chicago</div>
  </div>
  <div class="item">
    <div class="header">Los Angeles</div>
  </div>
  <div class="item">
    <div class="header">San Francisco</div>
  </div>
</div>

<p>Category <i class="ui icon angle right"></i></p>
<p>Category <i class="ui icon angle right"></i></p>
<p>Category <i class="ui icon angle right"></i></p> -->
</div>
  
  
</div>
                <!-- <div class="storedElementListContainer"></div>
                <h2 class="markerTypeFilter"></h2> -->
                

</div>
<div class="sidebar-pane" id="markerLayers">
                <h1 class="sidebar-header">
                    <span class="appTitle"></span>
                    <span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>

                <h2 class="ui header">Marker layers</h2>

                <p>This lets you organize different types of markers on the same map, and toggle one or more on or off.</p>
                <div class="ui divider"></div>
                <div class="item" style="
    padding: 0px;
">     <div class="ui fluid button openCreateNewMarkerLayerModal" tabindex="0">   <span class="text"><i class="fa fa-layer-group noIconPadding" style="
"></i> Create new layer</span>    </div>        </div>
                <div class="ui middle aligned divided list markerLayersList">

  
  
</div>
<div class="ui fluid button showAllMarkersButton" tabindex="0">   <span class="text"> Show all markers</span>    </div>

</div>
            </div>
    </div>

    

  <div class="ui dropdown">
    <div class="menu transition markerMenu" tabindex="-1">
      <div class="item addNewElementButton">New element...</div>
      <div class="item quickAddButton">Quick-add marker</div>
      <div class="divider"></div>
      <div class="item cancelMenuButton">Cancel</div>
  </div>
</div>

<div id="image-map"></div>

    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
    <script src="js/leaflet-sidebar.js"></script>
    
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/semantic.js"></script>
      <script src="https://cloud.tinymce.com/stable/tinymce.min.js?apiKey=0iikpzpie668ykdytq99jv9g87bgpj1hx9jp09ihe7uwbcoy"></script>

      <script src="libraries/ckeditor/ckeditor.js"></script>

    <script>


      var pathname = window.location.pathname;
      if (pathname == "/") {pathname = ""};
      console.log(pathname)

    var appInit = {
    appTitle: "Cartonomicon (BETA)",
    mapSource: pathname + "api.php/records/maps",
    markerLayerSource: pathname + "api.php/records/marker_layers",
    markerSource: pathname + "api.php/records/markers",
    wikiCategorySource: pathname + "api.php/records/wiki_categories",
    limitString: ""
}

var selectedMapID = window.location.hash.split('/')[1] || ''; //If user is accessing a specific map
var selectedMarkerID = '';
var selectedArticleID = '';

if (window.location.hash.split('/')[2] == "marker") {
selectedMarkerID = window.location.hash.split('/')[3];
} else if (window.location.hash.split('/')[2] == "article") {
var selectedArticleID = window.location.hash.split('/')[3];
}


$('#image-map').attr('data-map-id', selectedMapID);


var storedMaps;
var storedMarkerLayers;
var storedMarkers;
var storedWikiCategories;

var markerLayerMarkers = {};

var storedElementsList = [];
var activeElementsList = [];
var linkedMapsList = [];

var activeMarkers = [];
var map; // currently-active map

var markersLayer;

var list; // list to generate listmarkers
var markerSearchIndex;
var mapSearchIndex;

var autoCompleteInitted = false;

function fetchData() {




    //Maps
    $.ajax({
        url: appInit.mapSource + appInit.limitString,
        method: "GET",
        success: function(data) {

            storedMaps = data.records;

            mapSearchIndex = [];

            for (var i = 0; i < storedMaps.length; i++) {
                mapSearchIndex.push({
                    category: "Existing maps",
                    title: storedMaps[i].title,
                    _id: storedMaps[i]._id,
                    mapImageURL: storedMaps[i].mapImageURL
                })
            }


            //Marker layers
            $.ajax({
                url: appInit.markerLayerSource + "?filter=mapID,eq," + selectedMapID,
                method: "GET",
                success: function(data) {

                    storedMarkerLayers = data.records

                    if (!selectedMapID) {
                      selectedMapID = storedMaps[0]._id;

                      window.location.href = '#/' + selectedMapID
                    }

                    populateMarkerLayers(storedMarkerLayers);

                    //Markers
                    $.ajax({
                        url: appInit.markerSource + "?filter=mapID,eq," + selectedMapID,
                        method: "GET",
                        success: function(data) {


                            storedMarkers = data.records

                            for (marker in storedMarkers) {
                              storedMarkers[marker].id = storedMarkers[marker]._id;
                              storedMarkers[marker].name = storedMarkers[marker].title.toLowerCase();


                          if (storedMarkers[marker].markerInStorage == 0 &&
                            storedMarkers[marker].markerLayerID) {
                          if (markerLayerMarkers.hasOwnProperty(storedMarkers[marker].markerLayerID) == false) {
                          markerLayerMarkers[storedMarkers[marker].markerLayerID] = [];
                          markerLayerMarkers[storedMarkers[marker].markerLayerID].push(storedMarkers[marker])
                          } else if (markerLayerMarkers[storedMarkers[marker].markerLayerID]) {
                          markerLayerMarkers[storedMarkers[marker].markerLayerID].push(storedMarkers[marker])
                          }
                          }

                          }

                              
                            $.ajax({
                        url: appInit.wikiCategorySource + "?order=title&filter=mapID,eq," + selectedMapID,
                        method: "GET",
                        success: function(data) {


                          storedWikiCategories = data.records;

                          populateWikiCategories(storedWikiCategories)
                          populateWikiCategoriesInDropdown(storedWikiCategories);






                            //Loop through markers to get all marker types
                            var storedElementTypes = [];

                            //Build search index
                            markerSearchIndex = [];
                            var customIcons = {}

                            for (var i = 0; i < storedMarkers.length; i++) {
                                storedMarkers[i].lastLatLng = storedMarkers[i].latLng.split(',');
                                
                                storedElementTypes.push(storedMarkers[i].elementType)
                                markerSearchIndex.push({
                                    category: storedMarkers[i].elementType ? storedMarkers[i].elementType : "No category",
                                    title: storedMarkers[i].title,
                                    _id: storedMarkers[i]._id
                                })
                            }

                            // var uniq = new Set(storedElementTypes.map(e => JSON.stringify(e)));
                            // var res = Array.from(uniq).map(e => JSON.parse(e));
                            // storedElementTypes = res;


                            var originalArticle;
                            var lastLatLng;
                            var lastSelectedMarker;

                            //Init the app data
                            $('.appTitle').text(appInit.appTitle);


                            var activeItem = "";
                            for (var i = 0; i < storedMaps.length; i++) {
                                if (storedMaps[i]._id == selectedMapID) {
                                    mapObject = storedMaps[i];
                                    activeItem = "active";
                                }



                                if (storedMaps[i].mapType == "worldmap") {
                                var mapItemTemplate = '<a href="#/' + storedMaps[i]._id + '/" class="item ' + activeItem + '" id="' + storedMaps[i]._id + '">' + storedMaps[i].title + '</a>'

                                $('.mapContainer').append(mapItemTemplate);
                                activeItem = "";
                              }
                            
                            }

                            main(mapObject, storedElementTypes, markerSearchIndex);



                            CKEDITOR.replace( 'markerDescription',
    {
        plugins: 'autocomplete,textmatch,toolbar,wysiwygarea,basicstyles,link,undo,table',
    });

// CKEDITOR.inline( 'articleContent');

$('#cke_articleContent').addClass('visibleModal');
$('#articleContent').attr('contenteditable', 'false');


                        }
                    });

                }
            });

        }
    });

  }
});


}



    var isEditingEnabled,
        toggle = document.getElementById( 'toggle' ),
        reset = document.getElementById( 'reset' ),
        articleContent = document.getElementById( 'articleContent' ),
        articleContentHTML = articleContent.innerHTML;



function disableWikiEditing() {
      if ( CKEDITOR.instances.articleContent )
        CKEDITOR.instances.articleContent.destroy();
    }

function updateCKEditor(instance, newHTML) {
		if (CKEDITOR.instances[instance].document) {
	        CKEDITOR.instances[instance].document.clearCustomData();
			CKEDITOR.instances[instance].document.removeAllListeners();
			CKEDITOR.instances[instance].window.getFrame().clearCustomData();
			CKEDITOR.instances[instance].window.getFrame().removeAllListeners();
            CKEDITOR.instances[instance].setData(newHTML);
        }
}

    // function enableEditing() {
    //   if ( !CKEDITOR.instances.articleContent ) {
    //     CKEDITOR.inline( 'articleContent', {
    //       extraAllowedContent: 'a(documentation);abbr[title];code',
    //       removePlugins: 'stylescombo',
    //       extraPlugins: 'sourcedialog',
    //       startupFocus: true
    //     } );
    //   }
    // }


function findSubcategoriesByCategoryID(categoryID) {
  var result = [];

  for (category in storedWikiCategories) {
    if (storedWikiCategories[category].parentID == categoryID) {
      result.push(storedWikiCategories[category]);
    }
  }
  return result;
}

function findMarkersByCategoryID(categoryID) {

  var result = [];

  for (marker in storedMarkers) {
    if (storedMarkers[marker].wikiCategoryID == categoryID) {
      result.push(storedMarkers[marker]);
    }
  }
  return result;

}

function toggleViewLinkMapButton(onOff) {
    

    if (onOff == "on") {
    
      if ($('.mapLinkLabel').text() == "View map") {
        $('#addMapToMarker').show();
      }
    
    } else if (onOff == "off") {
        $('#addMapToMarker').hide();
    }
    

    }

    function toggleUnlinkMapButton(onOff) {
    

    if (onOff == "on") {
    
      if ($('.mapLinkLabel').text() == "View map") {
        $('#unlinkMapButton').removeClass('hidden');
      }
    
    } else if (onOff == "off") {
        $('#unlinkMapButton').addClass('hidden');
    }
    

    }

    function removeAllMarkers() {
      for (m in activeMarkers) {
        activeMarkers[m].options.deleteMarker()
      }

      activeMarkers = [];
    }

    function addMarkerLayerMarkers(markerLayerMarkers) {

    	console.log(markerLayerMarkers);
      $('.elementListContainer').empty();

      for (m in markerLayerMarkers) {
      
        addMarkerData(markerLayerMarkers[m].lastLatLng, markerLayerMarkers[m].description, markerLayerMarkers[m].title, markerLayerMarkers[m].elementType, markerLayerMarkers[m].markerLayerID, markerLayerMarkers[m].id, markerLayerMarkers[m].markerBioImage, markerLayerMarkers[m].mapID, markerLayerMarkers[m].type, markerLayerMarkers[m].childMapID, markerLayerMarkers[m].customMarkerImage)

        


      }
    }

    function enableAutocomplete() {
      if (autoCompleteInitted == false) {
      // You will update this object in the course of this tutorial.
var config = {};

// Called when the user types in the editor or moves the caret.
// The range represents the caret position.
function textTestCallback( range ) {
    // You do not want to autocomplete a non-empty selection.
    if ( !range.collapsed ) {
        return null;
    }

    // Use the text match plugin which does the tricky job of performing
    // a text search in the DOM. The matchCallback function should return
    // a matching fragment of the text.
    return CKEDITOR.plugins.textMatch.match( range, matchCallback );
}

// Returns the position of the matching text.
// It matches a word starting from the '#' character
// up to the caret position.
function matchCallback( text, offset ) {
    // Get the text before the caret.
    var left = text.slice( 0, offset ),
        // Will look for a '#' character followed by a ticket number.
        match = left.match( /@.*$/ );

    if ( !match ) {
        return null;
    }
    return { start: match.index, end: offset };
}

config.textTestCallback = textTestCallback;

// The itemsArray variable is the example "database".
var itemsArray = storedMarkers;

// Returns (through its callback) the suggestions for the current query.
function dataCallback( matchInfo, callback ) {
    // Remove the '#' tag.
    var query = matchInfo.query.substring( 1 ).toLowerCase();

    // Simple search.
    // Filter the entire items array so only the items that start
    // with the query remain.
    var suggestions = itemsArray.filter( function( item ) {
        return String( item.name ).indexOf( query ) == 0;
    } );

    // Note: The callback function can also be executed asynchronously
    // so dataCallback can do an XHR request or use any other asynchronous API.
    callback( suggestions );
}

config.dataCallback = dataCallback;

config.itemTemplate = '<li data-id="{id}">{title}</li>';

config.outputTemplate = '<a href="#/'+selectedMapID+'/marker/{id}">{title}</a> ';

new CKEDITOR.plugins.autocomplete( CKEDITOR.instances.articleContent, config );
new CKEDITOR.plugins.autocomplete( CKEDITOR.instances.markerDescription, config );

console.log("Initted")
autoCompleteInitted = true;
    }
  }


    function toggleEditMode() {
        if ($('.markerTitle').attr('contenteditable') == "true") {
            //Turn off edit mode

            toggleUnlinkMapButton("off")
            toggleViewLinkMapButton('off')

            $('#saveMarkerEdit, #cancelMarkerEdit').hide();
            $('#editMarker, #deleteMarker').show();

            
            $('.markerLayerDropdownButton').addClass('hidden');
            $('.markerDescription').removeClass('hidden');
            $('#cke_markerDescription').hide();

            $('.fileUploadForm').toggleClass('hidden');

            // $('.addNewImageLink').fadeToggle(); // "Add new image link" field
            $('.markerTitle').attr('contenteditable', 'false');
            $('.markerDescription').attr('contenteditable', 'false');
            $('#editMarker').removeClass('active');
        } else {

            //Turn on edit mode


            enableAutocomplete()
            var markerID = $('#place').attr('data-marker-id');
            var description = selectActiveMarkerByID(markerID).options.description

            updateCKEditor('markerDescription', description);

            toggleUnlinkMapButton("on");
            toggleViewLinkMapButton("on");

            $('#saveMarkerEdit, #cancelMarkerEdit').fadeIn();
            $('#editMarker, #deleteMarker').hide();
            $('.markerLayerDropdownButton').removeClass('hidden');
            $('.markerDescription').addClass('hidden');
            $('#cke_markerDescription').fadeIn();

            $('.fileUploadForm').toggleClass('hidden');
            //$('.addNewImageLink').fadeToggle(); // "Add new image link" field
            $('.markerTitle').attr('contenteditable', 'true');
            $('.markerDescription').attr('contenteditable', 'true');
            $('#editMarker').addClass('active');
        }
    }

    function toggleWikiEditMode(onOff) {
        if (onOff == "off") {
            //Turn off edit mode

            // 
            // toggleUnlinkMapButton("off")
            // toggleViewLinkMapButton('off')

            $('#saveMarkerEdit, #cancelMarkerEdit').hide();
            $('#editMarker, #deleteMarker').show();

            $('.wikiCategoryDropdownButton').addClass('hidden');
            $('.markerLayerDropdownButton').addClass('hidden');
            $('.markerDescription').removeClass('hidden');
            $('#cke_markerDescription').hide();

            $('.fileUploadForm').toggleClass('hidden');

            // $('.addNewImageLink').fadeToggle(); // "Add new image link" field
            $('.markerTitle').attr('contenteditable', 'false');
            $('.markerDescription').attr('contenteditable', 'false');
            $('#editMarker').removeClass('active');
        } else {

            //Turn on edit mode


            enableAutocomplete()
            var markerID = $('#place').attr('data-marker-id');
            var description = selectActiveMarkerByID(markerID).options.description

            updateCKEditor('markerDescription', description);

            toggleUnlinkMapButton("on");
            toggleViewLinkMapButton("on");

            $('#saveMarkerEdit, #cancelMarkerEdit').fadeIn();
            $('#editMarker, #deleteMarker').hide();
            $('.wikiCategoryDropdownButton').removeClass('hidden');
            $('.markerLayerDropdownButton').removeClass('hidden');
            $('.markerDescription').addClass('hidden');
            $('#cke_markerDescription').fadeIn();

            $('.fileUploadForm').toggleClass('hidden');
            //$('.addNewImageLink').fadeToggle(); // "Add new image link" field
            $('.markerTitle').attr('contenteditable', 'true');
            $('.markerDescription').attr('contenteditable', 'true');
            $('#editMarker').addClass('active');
        }
    }

    function updateMarkerImage(imageURL) {

        var markerID = $('#place').attr('data-marker-id');

        if (confirm("Add new image for this marker?")) {
            $.ajax({
                url: appInit.markerSource + "/" + markerID,
                method: "PUT",
                data: {
                    markerBioImage: imageURL
                },
                success: function(data) {
                    setMarkerElementImage(imageURL);
                    // $('.addNewImageLink > input').val('');
                }

            });
        }
    }

    function deleteMarkerByID(id) {

        $.ajax({
            url: appInit.markerSource + '/' + markerID,
            method: "DELETE",
            success: function(data) {
                closeSidebar();

                for (marker in activeMarkers) {
                    activeMarkers[marker].options.deleteMarker();
                }


                //refreshMarkers();
                //^ a function to clear the current layer and repopulate with data from the server
            }

        });


    }


    function changeDropdownItem(itemID, dropdownClass) {

    if (itemID == -1 || itemID == 0) {

      var selectedLayerItem = $('.'+dropdownClass+' > .item.noItemSelected');
      
      if (dropdownClass == "markerLayerSelectMenu") {
      $('.currentlySelectedItemText').text("Select a layer for this marker");
      } else {
      $('.currentlySelectedItemText').text("Select an item...");
      $('.currentText').text($('.'+dropdownClass+' > .item').text())
      }

      $('.'+dropdownClass+' > .item').removeClass('selected active');
      $(selectedLayerItem).addClass('selected active');

    } else {

    if ($('.'+dropdownClass+' > .item[value="'+itemID+'"]').length) {
      
      var selectedLayerItem = $('.'+dropdownClass+' > .item[value="'+itemID+'"]');
      $('.currentlySelectedItemText').text($(selectedLayerItem).text());
      $('.'+dropdownClass+' > .item').removeClass('selected active');
      $(selectedLayerItem).addClass('selected active');
    
    }
    
    }

    }



    function removeMarkerFromStorage(markerID) {
      $.ajax({
            url: appInit.markerSource + '/' + markerID,
            method: "PUT",
            data: {
              markerInStorage: 0
            },
            success: function(data) {
                console.log(data, markerID)
                
                $('.storedElementListContainer > .markerType[data-marker-id="'+markerID+'"]').remove();

            }

        });
    }

    function moveMarkerToStorage(id) {

        if (!id) {
            var markerID = $('#place').attr('data-marker-id');
        } else {
            markerID = id;
        }

        $.ajax({
            url: appInit.markerSource + '/' + markerID,
            method: "PUT",
            data: {
              markerInStorage: 1
            },
            success: function(data) {
                console.log(data, markerID)

                //Remove marker from list of existing elements
                $('.elementListContainer > .markerType[data-marker-id="'+markerID+'"]').remove();

                //Remove marker from search index

                //Add marker to storage window
                var elementTemplate = '<div class="markerType" data-marker-id="' + markerID + '"><img class="ui avatar image" src="https://unpkg.com/leaflet@1.3.4/dist/images/marker-icon.png"></i>' + selectActiveMarkerByID(markerID).options.title + '</div>'

                    $('.storedElementListContainer').append(elementTemplate)

                lastSelectedMarker.deleteMarker();

            }

        });


    }

    function deleteMarker(id) {

        if (!id) {
            var markerID = $('#place').attr('data-marker-id');
        } else {
            markerID = id;
        }

        $.ajax({
            url: appInit.markerSource + '/' + markerID,
            method: "DELETE",
            success: function(data) {

                $('.markerType[data-marker-id="'+markerID+'"]').remove();

                if (selectMarkerByID(markerID).markerInStorage !== 1) {
                lastSelectedMarker.deleteMarker();
                }
                resetMarkerTitleAndDescription();
                //refreshMarkers();
                //^ a function to clear the current layer and repopulate with data from the server
            }

        });


    }

    function resetMarkerTitleAndDescription() {
        $('.markerTitle').text("No marker selected")
        $('.markerDescription').text('Select a marker on the map, its information will appear in this pane.');
    }

    function hideMarkerMenu() {
        $('.markerMenu').hide();
        $('.markerMenu > .item').removeClass('active');
    }


    


    function createMarkerFromExistingElement(markerID) {
      var markerObj = selectMarkerByID(markerID);


      addMarkerData(lastLatLng, markerObj.description, markerObj.title, markerObj.elementType, markerObj.markerLayerID, markerObj._id, markerObj.markerBioImage, markerObj.currentMapID, markerObj.childMapID)
    }

    function createMarkerFromLastLatLng(title, description, markerBioImage) {
        if (title) {
            // var mp = new L.Marker(lastLatLng, {
            //     description: description,
            //     title: title,
            //     draggable: true
            // }).bindPopup("<b>" + title + "</b>").addTo(markersLayer);

            //Get attributes from the currently-selected element type dropdown.
            var elementTypeTitle = $('.createNewElementDropdown > .text > .elementID').text();
            var elementTypeSafeTitle = $('.createNewElementDropdown > .text > .elementID').attr('data-element-safetitle');
            var elementTypeImage = $('.createNewElementDropdown > .text > img').attr('src');
            var elementType = 0;

            var currentMapID = $('#image-map').attr('data-map-id');
            markerBioImage = markerBioImage ? markerBioImage : "";

            var markerLayerID = 0; // Should be the ID of the current marker layer
            var id = "";
            var childMapID = "";

            var dataObj = {
                    "mapID": parseInt(currentMapID),
                    "latLng": lastLatLng.join(),
                    "title": title,
                    "customMarkerImage": "",
                    "markerLayerID" : 0,
                    "description": description,
                    "elementTypeID": elementType,
                    "markerBioImage": markerBioImage,
                    "markerInStorage" : 0
                }

            $.ajax({
                url: appInit.markerSource + "/",
                method: "POST",
                data: dataObj,
                success: function(data) {
                    console.log(data);
                    dataObj._id = data;
                    addMarkerData(lastLatLng, description, title, elementType, markerLayerID, data, markerBioImage, currentMapID, childMapID)

                    //Add a local copy of the new marker to both the primary list of markers,
                    //and the list of currently-showing markers.
                    storedMarkers.push(dataObj)
                    activeElementsList.push(dataObj)

                    $('.markerTitle').text(title);
                    $('.markerDescription').html(description);

                    updateCKEditor('markerDescription', description);
                    
                    $('#place').attr("data-marker-id", data);

                    if (!markerBioImage) {
                        hideMarkerElementImage();
                    }

                    closeSidebar();

                }

            });


        }

    }

    function hideMarkerElementImage() {
      $('.elementImage').hide();
      $('.elementImage').css('background-image', 'url()');
    }

    function setMarkerElementImage(mapImageURL) {
      $('.elementImage').show();

      //Calculate padding to use for background image
      var img = new Image();

      img.onload = function(){
        var height = img.height;
        var width = img.width;
      
        var paddingPercentage = Math.floor(height / width * 100)
        $('.elementImage').css('height', 0)
        $('.elementImage').css('padding-top', paddingPercentage + "%");
      }
      
      img.src = mapImageURL;



      $('.elementImage').css('background-image', 'url(' + encodeURI(mapImageURL) + ')');
    }

    function selectMarker(marker, mapImageURL) {

      console.log(marker)

        $('.markerMenu').hide();

        lastSelectedMarker = marker;


        // Handle sidebar stuff
        console.log(marker)

        $.ajax({
            url: appInit.markerSource + "/" + marker.options.id,
            method: "GET",
            success: function(data) {

                window.location.hash = '#/' + selectedMapID + '/marker/' + marker.options.id;

                markerObject = data;
                markerObject.lastLatLng = markerObject.latLng.split(',');

                var mapImageURL = markerObject.markerBioImage;


                //Retrieve marker info
                $('.markerTitle').text(markerObject.title);
                $('.markerDescription').html(markerObject.description);
                updateCKEditor('markerDescription', markerObject.description);
                $('#place').attr('data-marker-id', markerObject._id);
                if (mapImageURL) {
                    $('.addNewImageLink > input').val(mapImageURL);
                    setMarkerElementImage(mapImageURL);
                } else {
                    hideMarkerElementImage();
                    $('.addNewImageLink > input').val('');
                }


                if ($('#editMarker').hasClass('disabled')) {
                    $('#editMarker, #deleteMarker, #addMapToMarker').removeClass('disabled');
                }
                closeSidebar();

            }
        })



    }

    function updateDescription() {
      var markerID = $('#place').attr('data-marker-id');
      var description = CKEDITOR.instances.markerDescription.getData();
      $.ajax({
                        url: appInit.markerSource + '/' + markerID,
                        method: "PUT",
                        data: {
                            description: description
                        },
                        success: function(data) {
                            console.log(data);
                        }

                    });
    }


function populateAllMarkersMenu(markerArray) {

	$('.elementListContainer').empty();

	//Populate existing markers in the "All markers" menu
            for (var i = 0; i < markerArray.length; i++) {
                var skip = 0;

                if (markerArray[i].hasOwnProperty('markerInStorage')) {
                  if (markerArray[i].markerInStorage == 1) {
                    storedElementsList.push(markerArray[i])
                  skip = 1;
                } else {
                  activeElementsList.push(markerArray[i])
                }
                }

                if (markerArray[i].childMapID && markerArray[i].markerInStorage !== 1) {
                  linkedMapsList.push(markerArray[i]);
                }

                if (selectedMapID == markerArray[i].mapID && skip == false) {
                    markerArray[i].markerRef = addMarkerData(markerArray[i].lastLatLng, markerArray[i].description, markerArray[i].title, markerArray[i].elementType, markerArray[i].markerLayerID, markerArray[i]._id, markerArray[i].markerBioImage, markerArray[i].mapID, markerArray[i].type, markerArray[i].childMapID, markerArray[i].customMarkerImage);
                }
            }

            for (storedElement in storedElementsList) {
      var elementTemplate = '<div class="markerType" data-marker-id="' + storedElementsList[storedElement]._id + '"><img class="ui avatar image" src="https://unpkg.com/leaflet@1.3.4/dist/images/marker-icon.png"></i>' + storedElementsList[storedElement].title + '</div>'

    $('.storedElementListContainer').append(elementTemplate)
    }


    for (linkedMap in linkedMapsList) {
      var mapTemplate = '<div class="markerType" data-marker-id="'+linkedMapsList[linkedMap]._id+'"><img class="ui avatar map image" src="img/map-pin-icon.png">'+linkedMapsList[linkedMap].title+'</div>'

      $('.linkedMapsContainer').append(mapTemplate);
    }
}

function closeSidebar() {

        //Open the sidebar if it is closed
        $('.sidebar').addClass('collapsed');
        window.location.hash = '#/' + selectedMapID;
        $('.sidebar-pane').addClass('active');
        $('.sidebar-pane#place').removeClass('active');
    }

    function openSidebar() { // Opens the sidebar to the "place" tab
        $('.sidebar-pane').removeClass('active');
        $('.tab').removeClass('active');

        $('.tab.place').addClass('active');
        $('.sidebar-pane#place').addClass('active');

        //Open the sidebar if it is closed
        $('.sidebar').removeClass('collapsed');

        if ($('#place').attr('data-marker-id')) {
            window.location.hash = '#/' + selectedMapID + '/marker/' + $('#place').attr('data-marker-id');
        }
    }

    function switchToSidebarTab(tabClass) {
      $('.tab').removeClass('active');
      $('.'+tabClass).addClass('active');
      $('.sidebar-pane').removeClass('active');
      $('.sidebar-pane#'+tabClass).addClass('active');
    }


function addMarkerData(lastLatLng, description, title, elementType, markerLayerID, id, markerBioImage, mapID, type, childMapID, customMarkerImage) {


      var customIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.3.4/dist/images/marker-icon.png', //'/map/img/brent-l.jpg',
iconAnchor: [13, 40], 
popupAnchor: [0, -25] 
});


      // var customIcon = L.icon({
      //       iconUrl: "https://unpkg.com/leaflet@1.3.4/dist/images/marker-icon.png",
      //       iconSize: [60, 60], // size of the icon
      //       iconAnchor: [5, 50], // point of the icon which will correspond to marker's location
      //       popupAnchor: [20, -40] // point from which the popup should open relative to the iconAnchor
      //   });

      // if (customMarkerImage) {
      //   customIcon = L.icon({
      //       iconUrl: customMarkerImage,
      //       iconSize: [60, 60], // size of the icon
      //       iconAnchor: [5, 50], // point of the icon which will correspond to marker's location
      //       popupAnchor: [20, -40] // point from which the popup should open relative to the iconAnchor
      //   });
      // }

      console.log(customIcon)

        var mp = new L.Marker(lastLatLng, {
            description: description,
            title: title,
            id: id,
            icon: customIcon,
            elementType: elementType,
            draggable: true,
            lastLatLng: lastLatLng,
            childMapID: childMapID,
            markerBioImage: markerBioImage,
            markerLayerID: markerLayerID,
            flyTo: function() {
                map.flyTo(this.lastLatLng, 9);
                console.log(this.lastLatLng)
            },
            deleteMarker: function() {
                mp.remove();
            },
            rateLimit() {

            },
            selectThisMarker: function() {

                $('.markerMenu').hide();

                $('.currentMarker').removeClass('hidden');
                $('.allMarkers').addClass('hidden');
                $('.showThisMarker').addClass('active');
                $('.showAllMarkers').removeClass('active');
                

                lastSelectedMarker = this;
                var marker = this;
                console.log(marker)

                // Handle sidebar stuff
                console.log(marker)

                $.ajax({
                    url: appInit.markerSource + '/' + marker.id,
                    method: "GET",
                    success: function(data) {


                        

                        window.location.hash = '#/' + selectedMapID + '/marker/' + marker.id;

                        markerObject = data;

                        
                        changeDropdownItem(markerObject.markerLayerID, 'markerLayerSelectMenu');
                      


                        var mapImageURL = markerObject.markerBioImage;

                        //Retrieve marker info
                        $('.markerTitle').text(markerObject.title);
                        $('.markerDescription').html(markerObject.description);
                        if (CKEDITOR.instances.markerDescription.getData() !== markerObject.description) {
                        updateCKEditor('markerDescription', markerObject.description);
                        }
                        $('#place').attr('data-marker-id', markerObject._id);
                        if (mapImageURL) {
                            $('.addNewImageLink > input').val(mapImageURL);
                            console.log(mapImageURL)
                            setMarkerElementImage(mapImageURL);
                        } else {
                            hideMarkerElementImage();
                            $('.addNewImageLink > input').val('');
                        }


                        if ($('#editMarker').hasClass('disabled')) {
                            $('#editMarker, #deleteMarker, #addMapToMarker').removeClass('disabled');
                        }

                        if (type !== "quickMarker") {
                            openSidebar();
                        }

                    }
                })


                if (childMapID && childMapID !== -1) {
                $('.mapLinkLabel').text("View map");
                $('#addMapToMarker').show();
            } else {
                $('#addMapToMarker').hide();
                $('.mapLinkLabel').text("Link a map");
                
            }


            

            }

        }).bindPopup("<div data-attr-id='" + id + "'>" + title + "</div>").addTo(markersLayer);

        activeMarkers.push(mp);


        if ($('.elementListContainer > .markerType').length <= 50) {
            var elementTemplate = '<div class="markerType" data-marker-id="' + mp.options.id + '"><img class="ui avatar image" src="https://unpkg.com/leaflet@1.3.4/dist/images/marker-icon.png"><span>' + mp.options.title + '</span></div>'

            $('.elementListContainer').append(elementTemplate)
        }


        mp.on('click', function(e) {
          console.log(e)
            // selectMarker(e.target, markerBioImage);
            this.options.selectThisMarker();
            this.options.flyTo();

            this.options.rateLimit()
            
        });

        mp.on('mouseover', function(e) {
            this.openPopup();
        });

        mp.on('mouseout', function(e) {
            this.closePopup();
        });

        mp.on('dragend', function() {

            //TODO: Update marker latlng after drag end

            if (id) {

                var coord = String(mp.getLatLng());
                latLngArray = coord.split('(')[1].split(')')[0].split(', ');

                var markerID = id;

                $.ajax({
                    url: appInit.markerSource + "/" + markerID,
                    method: "PUT",
                    data: {
                        latLng: latLngArray.join()
                    },
                    success: function(data) {
                        console.log(data);
                        mp.options.lastLatLng = latLngArray;
                    }
                });




                mp.options.selectThisMarker();
            } else {
                "No ID found for this marker."
            }

        });

        $('.markerForm').hide();
        $('.createNewElementDropdown > .text').html("No marker layer selected")
        $('.markerTitleInput, .markerDescriptionInput').val('');

        if (selectedMarkerID == id) {
            mp.options.selectThisMarker();
            lastSelectedMarker = mp;

            openSidebar();
        }

        $('.leaflet-marker-icon').removeAttr('title');

        return mp;

    }



function selectActiveMarkerByID(markerID) {
    for (marker in activeMarkers) {
        if (activeMarkers[marker].options.id == markerID) {
            return activeMarkers[marker];
        }
    }
}

function selectMarkerByID(markerID) {
    for (marker in storedMarkers) {
        if (storedMarkers[marker]._id == markerID) {
            return storedMarkers[marker];
        }
    }
}

function selectMarkerLayerByID(layerID) {
  for (marker in storedMarkerLayers) {
        if (storedMarkerLayers[marker]._id == layerID) {
            return storedMarkerLayers[marker];
        }
    }
}

function selectWikiCategoryByID(articleID) {

  for (category in storedWikiCategories) {
    if (storedWikiCategories[category]._id == articleID) {
      return storedWikiCategories[category];
    }
  }

}

function enableWikiWYSIWYG() {

		var markerID = $('.wikiArticleModal').attr('data-marker-id');

			var markerObject = selectMarkerByID(markerID)

            var categoryTitle = selectWikiCategoryByID(markerObject.wikiCategoryID).title

            $('.currentWikiCategoryText').text(categoryTitle);

            $('.wikiCategorySelectMenu > .item').removeClass('active selected');
            $('.wikiCategorySelectMenu > .item[value="'+markerObject.wikiCategoryID+'"]').addClass('active selected') 

		originalArticle = $('#articleContent').html();

        $('.markerContextMenu.wikiSaveButtonContainer, .wikiCategoryDropdownButton').removeClass('hidden');
        $('.articleEditContainer').addClass('hidden');
        $('#cke_articleContent').addClass('visibleModal');
        $('#articleContent').attr('contenteditable', true);
        CKEDITOR.instances.articleContent.focus()
}

function disableWikiWYSIWYG() {
		originalArticle = $('#articleContent').html();
        $('#articleContent').html(originalArticle);
        $('.markerContextMenu.wikiSaveButtonContainer, .wikiCategoryDropdownButton').addClass('hidden');
        $('.articleEditContainer').removeClass('hidden');
        $('#cke_articleContent').removeClass('visibleModal');
        $('#articleContent').attr('contenteditable', false);
}

function openWikiModal(markerID) {
  var markerObj = selectMarkerByID(markerID);


  $('.articleTitleHeader').text(markerObj.title);
  $('.articleContent').html(markerObj.description);
  $('.wikiArticleModal').modal("show");
  $('.wikiArticleModal').attr('data-marker-id', markerID);
}

function populateWikiCategories(storedWikiCategoryList, elementToNavigateBackTo) {

	$('.wikiContainer').empty();

  for (category in storedWikiCategoryList) {
  if (!storedWikiCategoryList[category].parentID ||
  storedWikiCategoryList[category].parentID == -1) {
  var categoryTemplate = '<p class="categoryContainer"><span class="categoryDropdown" data-category-id="'+storedWikiCategoryList[category]._id+'"><i class="ui icon angle right"></i> <span class="categoryTitle">'+storedWikiCategoryList[category].title+'</span></span></p>'
  $('.wikiContainer').append(categoryTemplate);
  }
  }


//Navigate back to the selected category
  if (elementToNavigateBackTo) {
        var sectionArray = [];

function getSectionsToExpand(id) {

var thisArticle;

for (category in storedWikiCategories) {
        if (storedWikiCategories[category]._id == id) {
            thisArticle = storedWikiCategories[category];
        }
}

sectionArray.push(thisArticle._id);

if (thisArticle.parentID !== null &&
  thisArticle.parentID !== -1) {
  getSectionsToExpand(thisArticle.parentID);
}

}

getSectionsToExpand(elementToNavigateBackTo)
var sectionsToExpand = sectionArray;
console.log(sectionArray.reverse())

for (section in sectionsToExpand) {
$('[data-category-id="'+sectionsToExpand[section]+'"]').click();
}
    
    
      }


}

function createNewWikiCategory(title, parentID) {

var wikiCategoryID = $('.createNewWikiArticle').attr('data-category-id');

  $.ajax({
                url: appInit.wikiCategorySource + "/",
                method: "POST",
                data: {
                    "parentID": "",
                    "title": title,
                    "mapID": parseInt(currentMapID)
                },
                success: function(data) {
                    
                    resetWikiCategories(wikiCategoryID);

                }

            });

}

function resetWikiCategories(elementToNavigateBackTo) {



      $.ajax({
                        url: appInit.wikiCategorySource + "?order=title&filter=mapID,eq," + selectedMapID,
                        method: "GET",
                        success: function(data) {
                          console.log(data);

                          storedWikiCategories = data.records;

                          $('.wikiContainer').empty();

                          populateWikiCategories(data.records, elementToNavigateBackTo)


    }
  })
  }

function populateMarkerLayers(storedMarkerLayers) {
  $('.markerLayersList, .markerLayerSelectMenu').empty();

  //Specific to the pin menu marker layer dropdown
  $('.markerLayerSelectMenu').append('<div class="item noItemSelected">No layer</div>')


for (markerLayer in storedMarkerLayers) {

  var editModeDropdownItem = '<div value="'+storedMarkerLayers[markerLayer]._id+'" class="item">'+storedMarkerLayers[markerLayer].title+'</div>'

  var template = '<div class="item markerLayerContainer" data-layer-id="'+storedMarkerLayers[markerLayer]._id+'"> \
    <div class="right floated content"> \
      <div class="ui floating dropdown button toggleLayer"> \
  <span class="text">Toggle</span> \
  \
</div> \
      <div class="ui button editMarkerLayer">Edit</div> \
    </div> \
    <div class="content markerLayerLabel">'+storedMarkerLayers[markerLayer].title+'</div> \
  </div>'

//<div class="menu"> \
//    <div class="item hideLayerItem"> \
//      Show only this layer \
//    </div> \
//  </div> \

  $('.markerLayersList').append(template);
  $('.markerLayerSelectMenu').append(editModeDropdownItem);
                    }
}

function populateWikiCategoriesInDropdown(storedMarkerLayers) {
  $('.wikiCategorySelectMenu').empty();

  //Specific to the pin menu marker layer dropdown
  // $('.wikiCategorySelectMenu').append('<div class="item noCategorySelected">No category</div>')


for (category in storedWikiCategories) {
  var editModeDropdownItem = '<div value="'+storedWikiCategories[category]._id+'" class="item">'+storedWikiCategories[category].title+'</div>'
  $('.wikiCategorySelectMenu').append(editModeDropdownItem);
                    }
}

function populateMarkerLayers(storedMarkerLayers) {
  $('.markerLayersList, .markerLayerSelectMenu').empty();

  //Specific to the pin menu marker layer dropdown
  $('.markerLayerSelectMenu').append('<div class="item noItemSelected">No layer</div>')


for (markerLayer in storedMarkerLayers) {

  var editModeDropdownItem = '<div value="'+storedMarkerLayers[markerLayer]._id+'" class="item">'+storedMarkerLayers[markerLayer].title+'</div>'

  var template = '<div class="item markerLayerContainer" data-layer-id="'+storedMarkerLayers[markerLayer]._id+'"> \
    <div class="right floated content"> \
      <div class="ui floating dropdown button toggleLayer"> \
  <span class="text">Toggle</span> \
  \
</div> \
      <div class="ui button editMarkerLayer">Edit</div> \
    </div> \
    <div class="content markerLayerLabel">'+storedMarkerLayers[markerLayer].title+'</div> \
  </div>'

//<div class="menu"> \
//    <div class="item hideLayerItem"> \
//      Show only this layer \
//    </div> \
//  </div> \

  $('.markerLayersList').append(template);
  $('.markerLayerSelectMenu').append(editModeDropdownItem);
                    }
}

function resetAddNewDropdowns() {
  $('.addNew .text').each(function() {
  	$(this).text('Edit "' + $(this).attr('data-text') + '"...');
  })
  $('.addNew .menu > .item').removeClass('active selected')
}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}







function main(mapObject, storedElementTypes, markerSearchIndex) {

    if (map) {
        map.remove();
    }


    function getMenuPosition(mouse, direction, scrollDir) {
        var win = $(window)[direction](),
            scroll = $(window)[scrollDir](),
            menu = $(settings.menuSelector)[direction](),
            position = mouse + scroll;

        // opening menu would pass the side of the page
        if (mouse + menu > win && menu < mouse)
            position -= menu;

        return position;
    }


    //Validate image link
    function checkURL(url) {
        return (url.match(/\.(jpeg|jpg|gif|png)$/) != null);
    }




    // Using leaflet.js to pan and zoom a big image.
    // See also: http://kempe.net/blog/2014/06/14/leaflet-pan-zoom-image.html
    // create the slippy map

    //Get image width and height

    var imageWidth;
    var imageHeight;

    var img = $("<img />").attr('src', mapObject.mapImageURL)
        .on('load', function() {
            if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
                alert('broken image!');
            } else {
                imageWidth = img[0].width;
                imageHeight = img[0].height;

                mapObject.w = imageWidth;
                mapObject.h = imageHeight;
            }


            console.log(imageWidth, imageHeight)


            map = L.map('image-map', {
                minZoom: -3,
                maxZoom: 10,
                center: [imageWidth / 2, imageHeight / 2],
                zoom: 0,
                zoomSnap: 0.25,
                noWrap: true,
                dragging: true,
                // boxZoom: true,
                worldCopyJump: false,
                dragging: true,
                tap: false,

                crs: L.CRS.Simple,
                w: imageWidth,
                h: imageHeight,
                url: mapObject.mapImageURL
            });
            // dimensions of the image
            var w = imageWidth,
                h = imageHeight,
                url = mapObject.mapImageURL;

            // calculate the edges of the image, in coordinate space
            
            var southWest = map.unproject([0, h], map.getMaxZoom() - 1);
            var northEast = map.unproject([w, 0], map.getMaxZoom() - 1);
            var bounds = new L.LatLngBounds(southWest, northEast);

            // add the image overlay, 
            // so that it covers the entire map
            L.imageOverlay(url, bounds).addTo(map);
            var sidebar = L.control.sidebar('sidebar').addTo(map);

            // tell leaflet that the map is exactly as big as the image
            map.fitBounds(bounds);

            if (mapObject.parentMapID) {
                $('.upOneLevelButton').removeClass('hidden')
                    .attr('href', '#/' + mapObject.parentMapID);
            }

            $('.mapTitle .mapTitleHeader.text').text(mapObject.title);
            $('.mapDescription').text(mapObject.description);



            markersLayer = new L.LayerGroup(); //layer contain searched elements
            map.addLayer(markersLayer);



            map.on("click", function(e) {

                console.log(e)

                lastLatLng = [e.latlng.lat, e.latlng.lng];

                $('.markerMenu').show().css({
                    position: "absolute",
                    left: getMenuPosition(e.containerPoint.x, 'width', 'scrollLeft'),
                    top: getMenuPosition(e.containerPoint.y, 'height', 'scrollTop')
                })

            });

                                        var storedElementTypes = [{
                                    _id: "1",
                                    title: "Places",
                                    safeTitle: "places",
                                    image: "img/places.png"
                                },
                                {
                                    _id: "2",
                                    title: "People",
                                    safeTitle: "people",
                                    image: "img/people.png"
                                },
                                {
                                    _id: "3",
                                    title: "Artifacts",
                                    safeTitle: "artifacts",
                                    image: "img/artifacts.png"
                                }
                            ]


            //Populate element type selection dropdown
            for (var i = 0; i < storedMarkerLayers.length; i++) {

                var elementTypeTemplate = '<div class="item markerType"> \
      <span class="elementID" data-element-id="' + storedMarkerLayers[i]._id + '">' + storedMarkerLayers[i].title + '</span> \
    </div>';

                $('.containerFooter').before(elementTypeTemplate);
                $('.markerTypeContainer').append(elementTypeTemplate);

            }


            populateAllMarkersMenu(storedMarkers);


            //Script to control updating the contenteditable fields
            var title = $('.markerTitle').text();
            var description = CKEDITOR.instances.markerDescription.getData()
            $('.markerTitle, .markerDescription').blur(function() {
                if ($(this).hasClass('markerTitle') && title != $(this).text()) {
                    title = $(this).text();

                    var markerID = $('#place').attr('data-marker-id');

                    $.ajax({
                        url: appInit.markerSource + '/' + markerID,
                        method: "PUT",
                        data: {
                            title: title
                        },
                        success: function(data) {
                            console.log(data);
                            selectActiveMarkerByID(markerID).options.title = title;
                            selectMarkerByID(markerID).title = title;
                            selectActiveMarkerByID(markerID)._popup._content = "<div data-attr-id='" + markerID + "'>" + title + "</div>"
                            populateAllMarkersMenu(storedMarkers)
                        }

                    });


                } else if ($(this).hasClass('markerDescription') && description != $(this).html()) {
                    description = $(this).html();

                    var markerID = $('#place').attr('data-marker-id');

                    $.ajax({
                        url: appInit.markerSource + '/' + markerID,
                        method: "PUT",
                        data: {
                            description: description
                        },
                        success: function(data) {
                            console.log(data);
                        }

                    });

                }
            });
        });


    //Various handlers

    $('body').off();

    $('body').on('click', '.addNewElementButton', function() {
        $('.sidebar').addClass('collapsed');
        $('.ui.modal.addMarker').modal('show');
        $('.markerMenu').hide();
    })

    $('body').on('click', '.quickAddButton', function() {
        createMarkerFromLastLatLng("Quick marker", "No description added.");
        hideMarkerMenu();
    })

    $('body').on('click', '.mapContainer > .item', function() {
        window.location.reload();
    })

    $('body').on('click', '.cancelMenuButton', function() {
        hideMarkerMenu();
    })


    // Probably want to delete this, "stored markers" is no longer a screen.
    // $('body').on('click', '.storedElementListContainer > .markerType', function() {
    //   var markerID = $(this).attr('data-marker-id');
    //     if (confirm("Delete this stored marker forever?")) {
    //         deleteMarker(markerID);
    //     }
    // })

    

    $('body').on('click', '.editMarkerLayer', function() {

    var layerID = $(this).closest('[data-layer-id]').attr('data-layer-id')
    var originalText = $('[data-layer-id="'+layerID+'"]').find('.markerLayerLabel').text()

    var userRenamesMarkerLayer = prompt("Edit this layer name", originalText);

    if (userRenamesMarkerLayer && userRenamesMarkerLayer !== originalText) {
      $.ajax({
                        url: appInit.markerLayerSource + '/' + layerID,
                        method: "PUT",
                        data: {
                            title: userRenamesMarkerLayer
                        },
                        success: function(data) {
                            $('[data-layer-id="'+layerID+'"]').find('.markerLayerLabel').text(userRenamesMarkerLayer);
                            selectMarkerLayerByID(layerID).title = userRenamesMarkerLayer;
                        }

                    });
    }
        

    })

    //User toggles a specific marker layer
    $('body').on('click', '.toggleLayer', function(e) {

      lastSelectedMarker = "";

      if ($(this).closest('.markerLayerContainer').hasClass('active')) {

        $('.markerLayerContainer').removeClass('active');
      removeAllMarkers();
      addMarkerLayerMarkers(activeElementsList)
      window.location.hash = '#/' + selectedMapID
      } else {

      

      e.preventDefault()
      
      var layerID = $(this).closest('[data-layer-id]').attr('data-layer-id')
      window.location.hash = '#/' + selectedMapID + "/?markerLayer=" + layerID
      
      $(this).closest('.dropdown').find('.text').text('Toggle');
      $('.markerLayerContainer').removeClass('active');
      $(this).closest('.markerLayerContainer').addClass('active');

      removeAllMarkers();

    markerLayerMarkers = {};
    
    for (marker in storedMarkers) {

        storedMarkers[marker].id = storedMarkers[marker]._id;
        storedMarkers[marker].name = storedMarkers[marker].title.toLowerCase();
     	
     	if (storedMarkers[marker].markerInStorage == 0 &&
     	    	storedMarkers[marker].markerLayerID) {
     			if (markerLayerMarkers.hasOwnProperty(storedMarkers[marker].markerLayerID) == false) {
     				markerLayerMarkers[storedMarkers[marker].markerLayerID] = [];
     				markerLayerMarkers[storedMarkers[marker].markerLayerID].push(storedMarkers[marker])
     			} else if (markerLayerMarkers[storedMarkers[marker].markerLayerID]) {
     				markerLayerMarkers[storedMarkers[marker].markerLayerID].push(storedMarkers[marker])
     			}
     		}	
    }



      addMarkerLayerMarkers(markerLayerMarkers[layerID])
      }
    })





    $('body').on('click', '.showAllMarkersButton', function() {

      $('.markerLayerContainer').removeClass('active');
      removeAllMarkers();
      addMarkerLayerMarkers(activeElementsList)
      window.location.hash = '#/' + selectedMapID;


    })



    $('body').on('click', '#editWikiArticle', function() {
    	enableWikiWYSIWYG();
    })

    $('body').on('click', '#cancelArticleEdit', function() {
    	disableWikiWYSIWYG()
    })

    $('body').on('click', '#saveArticleEdit', function() {
        
        var markerID = $('.wikiArticleModal').attr('data-marker-id');
        var description = CKEDITOR.instances.articleContent.getData();

                    $.ajax({
                        url: appInit.markerSource + '/' + markerID,
                        method: "PUT",
                        data: {
                            description: description
                        },
                        success: function(data) {

                            console.log(data);
                            $('#articleContent').html()
                            $('.markerContextMenu.wikiSaveButtonContainer').addClass('hidden');
                            $('.articleEditContainer').removeClass('hidden');
                            $('#cke_articleContent').removeClass('visibleModal');
                            $('#articleContent').attr('contenteditable', 'false');

                            selectMarkerByID(markerID).description = description;

                        }

                    });


        
        //Disable wiki WYSIWYG
    })

    $('body').on('click', '#deleteWikiArticle', function() {
        
        if (confirm("Really delete this wiki article?")) {
        
        var wikiCategoryID = $('.createNewWikiCategory').attr('data-category-id');
        var markerID = $('.wikiArticleModal').attr('data-marker-id');
        var description = CKEDITOR.instances.articleContent.getData();

                    $.ajax({
                        url: appInit.markerSource + '/' + markerID,
                        method: "DELETE",
                        success: function(data) {

                            console.log(data);
                            $('#articleContent').html()
                            $('.markerContextMenu.wikiSaveButtonContainer').addClass('hidden');
                            $('.articleEditContainer').removeClass('hidden');
                            $('#cke_articleContent').removeClass('visibleModal');
                            $('#articleContent').attr('contenteditable', 'false');

                            for (marker in storedMarkers) {
                              if (storedMarkers[marker]._id == markerID) {
                                  storedMarkers.splice(marker, 1);
                              }
                            } 
    

                            resetWikiCategories(wikiCategoryID);


                        }

                    });


        
        //Disable wiki WYSIWYG
      }
    })
    

    $('body').on('click', '#deleteMarker', function() {
        var markerID = $('#place').attr('data-marker-id');

        $('.addMarkerToWiki').attr('data-marker-id', markerID);
        $('.addMarkerToWiki').modal('show');

        // if (confirm("Put this marker back in storage?")) {
        //     moveMarkerToStorage(markerID);
        // }
    })

    $('body').on('mouseover', '.elementListContainer > .markerType', function() {
        var markerID = $(this).attr('data-marker-id');
        selectActiveMarkerByID(markerID).openPopup()
    })

    $('body').on('mouseout', '.markerType', function() {
        var markerID = $(this).attr('data-marker-id');
        selectActiveMarkerByID(markerID).closePopup()
    })

    $('body').on('click', '.markerType', function() {
    	$('.modal').modal('hide');
        var markerID = $(this).attr('data-marker-id');
        var markerToSelect = selectActiveMarkerByID(markerID);
        markerToSelect.options.selectThisMarker();
        markerToSelect.options.flyTo();
    })


    $('body').on('click', '.addNewMarkerLayerButton', function() {
      var title = $('.createNewMarkerLayerModal input').val();

      if (title !== "") {

      var dataObj = {
                    title: title,
                    mapID: selectedMapID,
                    description: ""
                }

      $.ajax({
                url: appInit.markerLayerSource + "?filter=mapID,eq," + selectedMapID,
                method: "POST",
                data: dataObj,
                success: function(data) {
                    dataObj._id = data;
                    //Add the new marker layer to storedMarkerLayers and repopulate marker layers with the new object added

                    storedMarkerLayers.push(dataObj);

                    populateMarkerLayers(storedMarkerLayers);

                    $('.createNewMarkerLayerModal input').val('');

                }

            });
    } else {
      alert("Please enter a title.")
    }
    })

    $('body').on('click', '.addNewWikiElement .menu', function() {
      resetAddNewDropdowns()
    })

    $('body').on('click', '.newArticle', function() {

      if ($(this)[0].hasAttribute('data-category-id')) {
        $('.createNewWikiArticle').attr('data-category-id', $(this).attr('data-category-id'))
      } else {
        $('.createNewWikiArticle').removeAttr('data-category-id');
      }

      $('.createNewWikiArticle input').val('');
      $('.createNewWikiArticle').modal('show')
    })


    $('body').on('click', '.newCategory', function() {

      if ($(this)[0].hasAttribute('data-category-id')) {
        $('.createNewWikiCategory').attr('data-category-id', $(this).attr('data-category-id'))
      } else {
        $('.createNewWikiCategory').removeAttr('data-category-id');
      }

      $('.createNewWikiCategory input').val('');
      $('.createNewWikiCategory').modal('show')
    })



    $('body').on('click', '.renameCategory', function() {

    var categoryID = $(this).attr('data-category-id')
    var originalText = $('[data-category-id="'+categoryID+'"]').find('.categoryTitle').text();

    var userRenamesWikiCategory = prompt("Edit this category name", originalText);

    if (userRenamesWikiCategory && userRenamesWikiCategory !== originalText) {
      $.ajax({
            url: appInit.wikiCategorySource + '/' + categoryID,
            method: "PUT",
            data: {
                title: userRenamesWikiCategory
            },
            success: function(data) {
                $('.open[data-category-id="'+categoryID+'"]').find('.categoryTitle').text(userRenamesWikiCategory);

                selectWikiCategoryByID(categoryID).title = userRenamesWikiCategory;
                resetWikiCategories(categoryID);
            }

        });
    }

    })

    $('body').on('click', '.deleteCategory', function() {

    var categoryID = $(this).attr('data-category-id')

    if (confirm("Really delete this category? Any elements underneath it will be orphaned and inaccessible.")) {
      $.ajax({
            url: appInit.wikiCategorySource + '/' + categoryID,
            method: "DELETE",
            success: function(data) {
                $('.open[data-category-id="'+categoryID+'"]').remove();
                $('[data-parent-category-id="'+categoryID+'"]').remove();

                for (category in storedWikiCategories) {
                              if (storedWikiCategories[category]._id == categoryID) {
                                  storedWikiCategories.splice(category, 1);
                              }
                } 

            }

        });
    }

    })




    $('body').on('click', '.addNewCategoryButton', function() {
      var title = $('.createNewWikiCategory input').val();
      var parentID = $('.createNewWikiCategory').attr('data-category-id');


      if (!parentID) {
        parentID = -1;
      }

      if (title !== "") {

      $.ajax({
                url: appInit.wikiCategorySource + "/",
                method: "POST",
                data: {
                    parentID: parentID,
                    title: title,
                    mapID: selectedMapID
                },
                success: function(data) {
                    
                    resetWikiCategories(parentID);

                }

            });
    } else {
      alert("Please enter a title.")
    }
    })

    $('body').on('click', '.addNewArticleButton', function() {
      var title = $('.createNewWikiArticle input').val();
      var wikiCategoryID = $('.createNewWikiArticle').attr('data-category-id');

      if (title !== "") {

        var dataObj = {
                    "mapID": selectedMapID,
                    "latLng": "0,0",
                    "title": title,
                    "customMarkerImage": "",
                    "markerLayerID" : 0,
                    "description": "",
                    "elementTypeID": 0,
                    "markerBioImage": "",
                    "markerInStorage" : 1,
                    "wikiCategoryID" : wikiCategoryID
                }

        $.ajax({
                url: appInit.markerSource + "/",
                method: "POST",
                data: dataObj,
                success: function(data) {

                    console.log(data);
                    dataObj._id = data;
                    storedMarkers.push(dataObj)
                    resetWikiCategories(wikiCategoryID);

                }

            });

      
      } else {
        alert("Please enter a title.")
      }
    })







    $('body').on('click', '.openCreateNewMarkerLayerModal', function() {
      $('.createNewMarkerLayerModal').modal('show');
    })

    $('body').on('click', '#closeWikiModal', function() {
      $('.wikiArticleModal').modal('hide');
    })

    $('body').on('click', '#editMarker', function() {
        toggleEditMode();
        $('#addMapToMarker').show();
    })

    $('body').on('click', '#cancelMarkerEdit', function() {
        toggleEditMode();
        toggleViewLinkMapButton('on')
    })


$('body').on('click', '.subcategoryItem', function(event) {
  var markerID = $(this).attr('data-marker-id');
  selectedArticleID = markerID;
  event.stopPropagation();
  $('.subcategoryItem').removeClass('active');
  $(this).addClass('active');

  disableWikiWYSIWYG()

  window.location.hash = '#/' + selectedMapID + '/article/' + selectedArticleID;

  openWikiModal(markerID)

})




$('body').on('click', '.addNewWikiElement', function(event) {
  event.stopPropagation();

  var categoryID = $(this).attr('data-category-id');

  var wikiCategory = selectWikiCategoryByID(categoryID);

  if ($(event.target).hasClass('newArticle')) {

    //Create a new marker in storage

  } else if ($(event.target).hasClass('newCategory')) {

    //Create a new wiki category with wikiCategory set as the parentID

  }
  

})


$('body').on('click', '.categoryDropdown, .subcategoryDropdown', function(event) {


  var thisCategoryID = $(this).attr('data-category-id');


  event.stopPropagation();



if ($(this).hasClass('open') == false) {

	var categoryID = $(this).attr('data-category-id');
	var categoryText = $(this).text();
	
	var sectionCategories = findSubcategoriesByCategoryID(categoryID);
	var sectionMarkers = findMarkersByCategoryID(categoryID);
	
	var categoryTemplate = "";
	var markerListTemplate = "";


	for (category in sectionCategories) {
	categoryTemplate += '<p class="subcategoryDropdown" data-parent-category-id="'+categoryID+'" data-category-id="'+	sectionCategories[category]._id+'"><i class="ui icon angle right"></i> <span class="categoryTitle">'+sectionCategories	[category].title+'</span></p>';
	}
	
	for (marker in sectionMarkers) {
    if (sectionMarkers[marker].markerInStorage == 1) {
	markerListTemplate += '<div data-marker-id="'+sectionMarkers[marker]._id+'" data-parent-category-id="'+categoryID+'" 	class="item subcategoryItem"><div class="header">'+sectionMarkers[marker].title+'</div></div>'
	}
  }
	
	markerListTemplate += '<div class="addNew item"><div data-category-id="'+categoryID+'" class="header 	addNewWikiElement"><div class="ui inline dropdown"><i class="fa fa-edit noIconPadding"></i> \
	  <div class="text" data-text="'+categoryText+'"><span class="categoryTitle">Edit "'+categoryText+'"...</span></div> \
	  <i class="dropdown icon"></i> \
	  <div class="menu"> \
	    <div data-category-id="'+categoryID+'" class="item newArticle">Add new article here</div> \
	    <div data-category-id="'+categoryID+'" class="item newCategory">Add new category here</div> \
	    <div class="divider"></div> \
	    <div data-category-id="'+categoryID+'" class="item renameCategory">Rename</div> \
	    <div data-category-id="'+categoryID+'" class="item deleteCategory"><i class="fa fa-trash"></i> Delete</div> \
	  </div> \
	</div></div></div>';

	if ($(this).hasClass('subcategoryDropdown')) {
	$(this).append(categoryTemplate)
	$(this).append(markerListTemplate)
	$(this).find('.ui.segments, .markerListContainer').slideToggle();
	} else {
	$(this).parent().append(categoryTemplate)
	$(this).parent().append(markerListTemplate)
	$(this).parent().find('.ui.segments, .markerListContainer').slideToggle();
	}
	
	$('.ui.inline.dropdown').dropdown();

	$(this).addClass('open');
	$(this).find('i').first().removeClass('right').addClass('down');
	
} else {
	  if ($(this).hasClass('subcategoryDropdown')) {
	    $(this).find('p, div').remove();
	    $(this).find('.ui.segments, .markerListContainer').slideToggle();
	  } else {
	    $(this).parent().find('p, div').remove();
	    $(this).parent().find('.ui.segments, .markerListContainer').slideToggle();
	  }
	  $(this).removeClass('open');
	  $(this).find('i').first().removeClass('down').addClass('right');
}


resetAddNewDropdowns();
$('#articleContent').attr('contenteditable', 'false');


});




    $('body').on('click', '#saveMarkerEdit', function() {
        var description = CKEDITOR.instances.markerDescription.getData()

                    var markerID = $('#place').attr('data-marker-id');

                    $.ajax({
                        url: appInit.markerSource + '/' + markerID,
                        method: "PUT",
                        data: {
                            description: description
                        },
                        success: function(data) {
                            console.log(data);
                            toggleEditMode();
                            $('.markerDescription').html(description)
                            selectActiveMarkerByID(markerID).options.description = description;
                        }

                    });
    })


    

    $('body').on('click', '.editMapDetails', function() {
      $('.editMapNameInput').val(mapObject.title)
      $('.editMapDescriptionInput').val(mapObject.description);
      $('.editMapDetailsModal').modal('show');
      $('.mapTitleHeader').text(mapObject.title);
    })

    $('body').on('click', '.deleteWorldmap', function() {
      
      if (confirm("Do you really want to delete " + mapObject.title + "?")) {

        var currentMapID = mapObject._id;

        $.ajax({
            url: appInit.mapSource + "/" + currentMapID,
            method: "DELETE",
            success: function(data) {
                window.location.href = "#/"
            }

        });
      }

    })

    

    $('body').on('click', '.editMapButton', function() {

      var currentMapID = mapObject._id;

      var newMapTitle = $('.editMapNameInput').val();
      var newMapDescription = $('.editMapDescriptionInput').val();
      console.log(newMapTitle, newMapDescription)

       $.ajax({
                    url: appInit.mapSource + "/" + currentMapID,
                    method: "PUT",
                    data: {
                        title: newMapTitle,
                        description: newMapDescription
                    },
                    success: function(data) {
                      $('.mapTitleHeader').text(newMapTitle);
                      $('.mapDescription').html(newMapDescription);
                        console.log(data);
                        $('.editMapDetailsModal').modal('hide');
                    }
                });


    })

    

    $('body').on('click', '.createNewWorldmap', function() {
      $('.createNewWorldmapModal').modal('show');
    })

    $('body').on('click', '.addWorldmapButton', function() {

      $('.uploadNewWorldmapButton').click();

    })


    $('body').on('click', '#unlinkMapButton', function() {

      var markerID = $('#place').attr('data-marker-id');

      $.ajax({
        url: appInit.markerSource + "/" + markerID,
        method: "PUT",
        data: {
            childMapID: -1
        },
        success: function(data) {
          window.location.reload();
          }
    })
  })


    $('body').on('click', '#addMapToMarker', function() {

        var markerID = $('#place').attr('data-marker-id');
        console.log(selectActiveMarkerByID(markerID));
        if (selectActiveMarkerByID(markerID).options.childMapID
            && selectActiveMarkerByID(markerID).options.childMapID !== -1) {
            var marker = selectActiveMarkerByID(markerID);
            //Marker has a linked map

            window.location.href = "#/" + marker.options.childMapID;
            window.location.reload();
        } else {

            //No map linked - bring up map link modal

            $('.addMapToMarkerModal').attr('data-type', 'nested')
            $('.addMapToMarkerModal').modal('show');

            $('.createNewMapColumn').show();
            $('.mapLinkPreviewContainer').addClass('hidden');
            $('.createNewNestedMapForm').addClass('hidden');
        }
    })

    $('body').on('blur', '.addNewImageLink > input ', function() {
        if ($('.addNewImageLink > input').val().length &&
            checkURL($('.addNewImageLink > input').val())) {

            updateMarkerImage($('.addNewImageLink > input').val());

        }
    })

    $('body').on('click', '.createNewMapToggle', function() {
        $('.addMapToMarkerModal').attr('data-link-action', 'createNew');
        $('.createNewNestedMapForm').removeClass('hidden');
    })

    $('body').on('click', '.linkExistingMapToggle', function() {
        $('.addMapToMarkerModal').attr('data-link-action', 'linkExisting')
        $('.createNewNestedMapForm').addClass('hidden');
    })

    $('.fileUploadForm')
        .submit(function(e) {
            $.ajax({
                url: 'uploadElementImage.php',
                type: 'POST',
                data: new FormData(this),
                processData: false,
                contentType: false,
                success: function(data) {

                    console.log(data);

                    var result = JSON.parse(data);

                    console.log(result);

                    if (result.type == "error") {
                        //Something went wrong
                    } else if (result.type == "success") {

                    }

                    $('.uploadFileButton').addClass('disabled');
                    var id = $('#place').attr('data-marker-id');

                    $.ajax({
                        url: appInit.markerSource + "/" + id,
                        method: "PUT",
                        data: {
                            markerBioImage: 'img/element-images/' + result.file
                        },
                        success: function(data) {


                            setMarkerElementImage('img/element-images/' + result.file);
                            // $('.addNewImageLink > input').val('');
                        }

                    });


                }

            });
            e.preventDefault();
        });

        $('.uploadNewWorldmapForm')
        .submit(function (e) {
            $.ajax({
                url: 'uploadMapImage.php',
                type: 'POST',
                data: new FormData(this),
                processData: false,
                contentType: false,
                success: function(data) {

                    console.log(data);

                    var result = JSON.parse(data);

                    console.log(result);

                    if (result.type == "error") {
                        //Something went wrong
                    } else if (result.type == "success") {

                    }

                    
                    var id = $('#place').attr('data-marker-id');

                    var currentMapID = $('#image-map').attr('data-map-id');

                    var newMapTitle = $('.createNewMapNameInput').val();
                    var newMapDescription = $('.createNewMapDescriptionInput').val();

                    //Add the map to the DB
                    var currentMapID = mapObject._id;

                    var newMapTitle = $('.newWorldmapNameInput').val();
                    var newMapDescription = $('.newWorldmapDescriptionInput').val();
                    console.log(newMapTitle, newMapDescription)

                    $.ajax({
                    url: appInit.mapSource,
                    method: "POST",
                    data: {
                        title: newMapTitle,
                        mapImageURL: 'img/maps/' + result.file,
                        description: newMapDescription,
                        mapType: "worldmap",
                        parentMapID: "",
                        parentMarkerID : ""
                    },
                    success: function(data) {
                      window.location.href = "#/" + data;
                    }
                });
                    


                }

            });
            e.preventDefault();
        })


        

        $('.uploadNewMapForm')
        .submit(function(e) {
            $.ajax({
                url: 'uploadMapImage.php',
                type: 'POST',
                data: new FormData(this),
                processData: false,
                contentType: false,
                success: function(data) {

                    console.log(data);

                    var result = JSON.parse(data);

                    console.log(result);

                    if (result.type == "error") {
                        //Something went wrong
                    } else if (result.type == "success") {

                    }

                    
                    var id = $('#place').attr('data-marker-id');

                    var currentMapID = $('#image-map').attr('data-map-id');

                    var newMapTitle = $('.createNewMapNameInput').val();
                    var newMapDescription = $('.createNewMapDescriptionInput').val();

                    //Add the map to the DB
                    $.ajax({
                            url: appInit.mapSource,
                            method: "POST",
                            data: {
                                title: newMapTitle,
                                mapImageURL: 'img/maps/' + result.file,
                                description: newMapDescription,
                                mapType: "nested",
                                parentMapID: currentMapID,
                                parentMarkerID: selectedMarkerID
                            },
                            success: function(data) {
                              console.log(data);

                        //Update the marker with the map
                        $.ajax({
                        url: appInit.markerSource + "/" + id,
                        method: "PUT",
                        data: {
                            childMapID: data
                        },
                        success: function(data) {
                          window.location.reload();
                          }

                          });



                            }
                        })

                    


                }

            });
            e.preventDefault();
        });


    var inputs = document.querySelectorAll('.fileUploadForm .inputfile');
    Array.prototype.forEach.call(inputs, function(input) {
        var label = input.nextElementSibling,
            labelVal = label.innerHTML;

        input.addEventListener('change', function(e) {

            $('.uploadFileButton').click();

        });
    });


    

    

    // map.on('click', function(e){
    //   var coord = e.latlng;
    //   var lat = coord.lat;
    //   var lng = coord.lng;
    //   console.log("You clicked the map at latitude: " + lat + " and longitude: " + lng);
    //   });




    // var myMarker = L.marker([-4.33984375, 4.609375], {title: "MyPoint", alt: "The Big I", draggable: true})
    // .addTo(markersLayer)
    // .on('dragend', function() {
    //     var coord = String(myMarker.getLatLng()).split(',');
    //     console.log(coord);
    //     var lat = coord[0].split('(');
    //     console.log(lat);
    //     var lng = coord[1].split(')');
    //     console.log(lng);
    //     myMarker.bindPopup("Moved to: " + lat[1] + ", " + lng[0] + ".");
    // });



    // list = new L.Control.ListMarkers({
    //     layer: markersLayer,
    //     itemIcon: null
    // });
    // map.addControl(list);




    /* Set the width of the side navigation to 250px and the left margin of the page content to 250px and add a black background color to body */
    function openNav() {
        document.getElementById("mySidenav").style.width = "250px";
        document.getElementById("main").style.marginLeft = "250px";
        document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
    }

    /* Set the width of the side navigation to 0 and the left margin of the page content to 0, and the background color of body to white */
    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("main").style.marginLeft = "0";
        document.body.style.backgroundColor = "white";
    }




    //UI Initialization
    $('.markerLayerSelect').dropdown({clearable: true});


    // $('.dropdown').dropdown();
    $('.ui.inline.dropdown, .createNewElementDropdown').dropdown();
    $('.ui.radio.checkbox').checkbox();  


    $('body').on('click', '.showThisMarker', function() {
        $(this).addClass('active');
        $('.showAllMarkers').removeClass('active');

        $('.currentMarker').removeClass('hidden');
        $('.allMarkers').addClass('hidden');
    });

    $('body').on('click', '.showAllMarkers', function() {
        $(this).addClass('active');
        $('.showThisMarker').removeClass('active');
        
        $('.currentMarker').addClass('hidden');
        $('.allMarkers').removeClass('hidden');
    });

    $('body').on('click', '.createNewElementDropdown .item', function() {
        $('.markerForm').show();
    });

    //When clicking to add a new marker
    $('.addMarkerButton').click(function() {

        var title = $('.markerTitleInput').val();
        var description = $('.markerDescriptionInput').val();
        createMarkerFromLastLatLng(title, description)
    })




    $('.addMapButton').click(function() {
        var mapType = $('.addMapToMarkerModal').attr('data-type'); //nested or worldmap
        var linkAction = $('.addMapToMarkerModal').attr('data-link-action'); //createNew or linkExisting
        var selectedMarkerID = $('#place').attr('data-marker-id');

        if (mapType == "nested") {
            //We're linking a map to a marker



            if (linkAction == "createNew") {

                var newMapTitle = $('.createNewMapTitle').val();
                var newMapDescription = $('.createNewMapDescription').val();
                var currentMapID = $('#image-map').attr('data-map-id');
                var mapImageURL = $('.mapLinkPreview').attr('src');
                var existingMapID = $('.addMapToMarkerModal').attr('existing-map-id'); //id of existing map to link

                $.ajax({
                    url: appInit.mapSource + "/" + existingMapID,
                    method: "GET",
                    success: function(data) {
                        console.log(data);

                        $.ajax({
                            url: appInit.mapSource,
                            method: "POST",
                            data: {
                                title: newMapTitle,
                                mapImageURL: data.mapImageURL,
                                description: newMapDescription,
                                mapType: "nested",
                                parentMapID: currentMapID,
                                parentMarkerID: selectedMarkerID
                            },
                            success: function(data) {


                            }
                        })

                        $.ajax({
                            url: appInit.mapSource,
                            method: "POST",
                            data: {
                                title: newMapTitle,
                                mapImageURL: mapImageURL,
                                description: newMapDescription,
                                mapType: "nested",
                                parentMapID: currentMapID,
                                parentMarkerID: selectedMarkerID
                            },
                            success: function(data) {


                                $.ajax({
                                    url: appInit.markerSource + "/" + selectedMarkerID,
                                    method: "PUT",
                                    data: {
                                        childMapID: data
                                    },
                                    success: function(data) {
                                        console.log(data);
                                    }

                                });


                                $('.addMapToMarkerModal').modal('hide');
                            }
                        });
                    }
                })



            } else if (linkAction == "linkExisting") {


                var existingMapID = $('.addMapToMarkerModal').attr('existing-map-id'); //id of existing map to link
                var currentMapID = $('#image-map').attr('data-map-id');
                var mapImageURL = $('.mapLinkPreview').attr('src');
                var markerID = $('#place').attr('data-marker-id');

                $.ajax({
                        url: appInit.markerSource + "/" + markerID,
                        method: "PUT",
                        data: {
                            childMapID: existingMapID
                        },
                        success: function(data) {
                            console.log(data);
                            selectActiveMarkerByID(markerID).options.childMapID = existingMapID;
                            $('.mapLinkLabel').text("View map");
                            $('#addMapToMarker').show();
                        }

                    });


            } else {
              if ($('.createNewMapNameInput').val().length) {
                //Trigger the upload chain
                $('.uploadNewMapButton').click()
              }
            }

        } else if (mapType == "worldmap") {
            //We're adding a new worldmap

        }

    })

    $('.ui.search.markerSearch')
        .search({
            type: 'category',
            source: markerSearchIndex,
            onSelect: function(result) {
              console.log(result);
              if ($(this).hasClass('linkElementSearch') == false) {
                console.log("No link elment search")
                var thisMarkerElement = selectActiveMarkerByID(result._id);
                if (thisMarkerElement) {
                thisMarkerElement.options.selectThisMarker()
                thisMarkerElement.options.flyTo()
              	} else {
              		openWikiModal(result._id);
              	}
              } else { // We're selecting the element in the search box, close it
                $('.addMarker').modal('hide');
                $('.addMarker .prompt').val('');
                selectMarkerByID(result._id).markerInStorage = 0;
                var markerObj = selectMarkerByID(result._id);
                console.log(markerObj)

                removeMarkerFromStorage(result._id); 

                createMarkerFromExistingElement(result._id);
                resetMarkerTitleAndDescription();
                switchToSidebarTab('storedElements')
                resetWikiCategories(markerObj.wikiCategoryID);
               
              }
            }
        });

    $('.ui.search.mapSearch')
        .search({
            type: 'category',
            source: mapSearchIndex,
            onSelect: function(result) {
                console.log(result);
                $('.createNewMapColumn').hide();
                $('.addMapToMarkerModal').attr('data-link-action', 'linkExisting').attr('existing-map-id', result._id);
                $('.mapLinkPreviewContainer').removeClass('hidden');
                $('.mapLinkPreview').attr('src', result.mapImageURL);
            }
        });



        //User changes a marker's layer via the edit menu dropdown
    $('.markerLayerDropdownButton').dropdown({
      onChange: function(value, text, element) {
        console.log(value, text, $(element).attr('value'));

        var newLayerID;
        var markerID = $('#place').attr('data-marker-id');

        if (value == "no layer") {
          var newLayerID = 0;
        } else {
          var newLayerID = $(element).attr('value');
        }

        console.log(newLayerID)

        $.ajax({ 
                url: appInit.markerSource + "/" + markerID,
                method: "PUT",
                data: {
                    markerLayerID: newLayerID
                },
                success: function(data) {
                    console.log(data);
                    //Update the local data.
                    selectMarkerByID(markerID).markerLayerID = newLayerID;
                    console.log(selectMarkerByID(markerID))

                }

        });


      }
    });

    $('.wikiCategoryDropdownButton, .markerWikiCategoryDropdownButton').dropdown({
      onChange: function(value, text, element) {

      	var markerID = "";
      	var modalDropdown = $(this).hasClass('markerWikiCategoryDropdownButton');

      	var newWikiCategory = $(element).attr('value');
      	console.log($(this))
      	if (modalDropdown) {
		markerID = $('.addMarkerToWiki').attr('data-marker-id');
      	} else {
      	markerID = $('.wikiArticleModal').attr('data-marker-id');
    	}

    	if (selectMarkerByID(markerID)) {
        $.ajax({ 
                url: appInit.markerSource + "/" + markerID,
                method: "PUT",
                data: {
                    wikiCategoryID: newWikiCategory
                },
                success: function(data) {
                    console.log(data);
                    //Update the local data.
                    selectMarkerByID(markerID).markerInStorage = 1;
                    var markerObj = selectMarkerByID(markerID);
                    markerObj.wikiCategoryID = newWikiCategory;
                    if (modalDropdown) {
                    	moveMarkerToStorage(markerID);
                    	$('.addMarkerToWiki').modal('hide');

                      //Update local stored wiki category
              resetWikiCategories(newWikiCategory)
                    }
                    
        			

                }
        });

    	}
        
      }
    });



    //Use this to get the size of an image without appending it to the DOM.

    // var img = $("<img />").attr('src', 'http://localhost/map/img/artifacts.png')
    //     .on('load', function() {
    //         if (!this.complete || typeof this.naturalWidth == "undefined" || this.naturalWidth == 0) {
    //             alert('broken image!');
    //         } else {
    //             console.log(img[0].width, img[0].height)
    //         }
    //     });





function toggleMarkerLayer(markerLayerID) {

 //Implementing a query param for deep linking into marker layers

 if (markerLayerID) {

 	$('.markerLayerContainer').removeClass('active');
 	$('.markerLayerContainer[data-layer-id="'+markerLayerID+'"]').addClass('active');
 	
 	removeAllMarkers();
	markerLayerMarkers = {};
    
    for (marker in storedMarkers) {

        storedMarkers[marker].id = storedMarkers[marker]._id;
        storedMarkers[marker].name = storedMarkers[marker].title.toLowerCase();
     	
     	if (storedMarkers[marker].markerInStorage == 0 &&
     	    	storedMarkers[marker].markerLayerID) {
     			if (markerLayerMarkers.hasOwnProperty(storedMarkers[marker].markerLayerID) == false) {
     				markerLayerMarkers[storedMarkers[marker].markerLayerID] = [];
     				markerLayerMarkers[storedMarkers[marker].markerLayerID].push(storedMarkers[marker])
     			} else if (markerLayerMarkers[storedMarkers[marker].markerLayerID]) {
     				markerLayerMarkers[storedMarkers[marker].markerLayerID].push(storedMarkers[marker])
     			}
     		}	
    }



      addMarkerLayerMarkers(markerLayerMarkers[markerLayerID])
    }
  
}

/**
 * Copyright (c) 2003-2018, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or https://ckeditor.com/legal/ckeditor-oss-license
 */

setTimeout(function() {
 //Implementing a query param for deep linking into marker layers
 var layerID = getParameterByName('markerLayer');
 toggleMarkerLayer(layerID);
  }, 300);

 //Implementing 'article' URL hashes to auto-open articles
 //and the sidebar if an article ID is provided
 if (selectedArticleID) {
 	setTimeout(function() {
  disableWikiWYSIWYG();
  openSidebar();
  openWikiModal(selectedArticleID)
  switchToSidebarTab('storedElements');

var sectionArray = [];

getSectionsToExpand(selectMarkerByID(selectedArticleID).wikiCategoryID)
var sectionsToExpand = sectionArray;

var sectionsToExpand = sectionArray;
for (section in sectionsToExpand) {
$('[data-category-id="'+sectionsToExpand[section]+'"]').click();
}


 $('.subcategoryItem').removeClass('active');
  $('.subcategoryItem[data-marker-id="'+selectedArticleID+'"]').addClass('active');


  


}, 300);

}


}


var sectionArray = []

function getSectionsToExpand(id) {

console.log(id);

var thisArticle;

for (category in storedWikiCategories) {
        if (storedWikiCategories[category]._id == id) {
            thisArticle = storedWikiCategories[category];
        }
}

console.log(thisArticle)

sectionArray.push(thisArticle._id);

if (thisArticle.parentID !== null &&
  thisArticle.parentID !== -1) {
  getSectionsToExpand(thisArticle.parentID);
}

}








    
fetchData();



 window.onpopstate = function() {
     if (window.location.hash.split('/')[1] !== selectedMapID) {
         window.location.reload();
     } else {
       if (window.location.hash.split('/')[3] && window.location.hash.split('/')[2] == "marker") {
       	 $('.modal').modal('hide');
         selectActiveMarkerByID(window.location.hash.split('/')[3]).options.selectThisMarker();
         selectActiveMarkerByID(window.location.hash.split('/')[3]).options.flyTo()
       } else if (window.location.hash.split('/')[2] == "article") {
       openWikiModal(window.location.hash.split('/')[3]);	
       } else {
       	// window.location.reload();
       }
     }
}


</script>

    <script src="js/leaflet-list-markers.js"></script>


  </body>
</html>